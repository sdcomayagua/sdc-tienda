(()=>{const API_URL="https://script.google.com/macros/s/AKfycbytPfD9mq__VO7I2lnpBsqdCIT119ZT0zVyz0eeVjrJVgN_q8FYGgmqY6G66C2m67Pa4g/exec",CART_KEY="sdc_cart_pro_v1",THEME_KEY="sdc_theme_pro_v1",WA="50431517755",$=e=>document.getElementById(e),safe=e=>String(e??"").trim(),money=e=>`Lps. ${Math.round(Number(e||0)).toLocaleString("es-HN")}`,isOffer=e=>Number(e.precio_anterior||0)>Number(e.precio||0),isOut=e=>Number(e.stock||0)<=0;let DATA=null,PRODUCTS=[],BY_ID={},CART=[],CURRENT=null,CURRENT_CAT=null,CURRENT_SUB=null,QUERY="",STEP=1;const show=e=>e.classList.remove("hidden"),hide=e=>e.classList.add("hidden");function applyTheme(){const e=localStorage.getItem(THEME_KEY)||"dark";document.body.classList.toggle("light","light"===e),$("themeBtn").innerHTML="light"===e?'<i class="ri-sun-line"></i>':'<i class="ri-moon-line"></i>'}function toggleTheme(){const e=document.body.classList.contains("light");localStorage.setItem(THEME_KEY,e?"dark":"light"),applyTheme()}function openOverlay(){$("overlay").style.display="block"}function closeOverlay(){$("overlay").style.display="none"}function openModal(e){openOverlay(),$(e).style.display="block"}function closeModal(e){$(e).style.display="none","block"!==$("productModal").style.display&&"block"!==$("cartModal").style.display&&closeOverlay()}function loadCart(){try{CART=JSON.parse(localStorage.getItem(CART_KEY)||"[]")}catch(e){CART=[]}Array.isArray(CART)||(CART=[]),updateBadge()}function saveCart(){localStorage.setItem(CART_KEY,JSON.stringify(CART)),updateBadge()}function updateBadge(){$("cartCount").textContent=String(CART.reduce((e,t)=>e+Number(t.qty||0),0))}function cartSubtotal(){return CART.reduce((e,t)=>{const o=BY_ID[t.id];return o?e+Number(o.precio||0)*Number(t.qty||0):e},0)}async function loadAPI(){const e=await fetch(API_URL,{cache:"no-store"});if(!e.ok)throw new Error("API HTTP "+e.status);return await e.json()}function categoriesList(){let e=[];return DATA&&Array.isArray(DATA.categorias)&&DATA.categorias.length?e=DATA.categorias.filter(e=>"1"===String(e.visible??1)||1===e.visible||!0===e.visible).sort((e,t)=>Number(e.orden||999999)-Number(t.orden||999999)).map(e=>safe(e.categoria)).filter(Boolean):e=[...new Set(PRODUCTS.map(e=>e.categoria).filter(Boolean))].sort((e,t)=>e.localeCompare(t)),PRODUCTS.some(isOffer)&&e.unshift("OFERTAS"),e=e.filter(e=>"OFERTAS"===e||"OFERTAS"!==String(e).toUpperCase()),e}function subcategoriesList(e){if(!e||"OFERTAS"===e)return[];return[...new Set(PRODUCTS.filter(t=>t.categoria===e).map(e=>e.subcategoria).filter(Boolean))].sort((e,t)=>e.localeCompare(t))}function renderCategories(){const e=$("categoryBar");e.innerHTML="";const t=document.createElement("button");t.className="pill"+(CURRENT_CAT?"":" active"),t.textContent="VER TODO",t.onclick=(()=>{CURRENT_CAT=null,CURRENT_SUB=null,renderCategories(),renderSubcategories(),renderProducts()}),e.appendChild(t),categoriesList().forEach(o=>{if("OFERTAS"===o||o){const t=document.createElement("button");t.className="pill"+(CURRENT_CAT===o?" active":""),t.textContent=o,t.onclick=(()=>{CURRENT_CAT=o,CURRENT_SUB=null,renderCategories(),renderSubcategories(),renderProducts()}),e.appendChild(t)}})}function renderSubcategories(){const e=$("subcategories");e.innerHTML="";const t=subcategoriesList(CURRENT_CAT);if(!CURRENT_CAT||"OFERTAS"===CURRENT_CAT||0===t.length)return e.style.display="none",void 0;e.style.display="flex";const o=document.createElement("button");o.className="pill"+(CURRENT_SUB?"":" active"),o.textContent="Todas",o.onclick=(()=>{CURRENT_SUB=null,renderSubcategories(),renderProducts()}),e.appendChild(o),t.forEach(t=>{const o=document.createElement("button");o.className="pill"+(CURRENT_SUB===t?" active":""),o.textContent=t,o.onclick=(()=>{CURRENT_SUB=t,renderSubcategories(),renderProducts()}),e.appendChild(o)})}function filteredProducts(){let e=[...PRODUCTS];if(CURRENT_CAT&&(e="OFERTAS"===CURRENT_CAT?e.filter(isOffer):e.filter(e=>e.categoria===CURRENT_CAT)),CURRENT_SUB&&(e=e.filter(e=>e.subcategoria===CURRENT_SUB)),QUERY){const t=QUERY.toLowerCase().trim();t&&(e=e.filter(e=>(e.nombre||"").toLowerCase().includes(t)||(e.descripcion||"").toLowerCase().includes(t)||(e.subcategoria||"").toLowerCase().includes(t)))}return e.sort((e,t)=>{const o=e.stock>0?0:1,a=t.stock>0?0:1;if(o!==a)return o-a;const r=Number(e.orden||999999),d=Number(t.orden||999999);return r!==d?r-d:(e.nombre||"").localeCompare(t.nombre||"")}),e}function renderProducts(){const e=$("productsGrid"),t=filteredProducts();e.innerHTML="",$("productsTitle").textContent=`Productos (${t.length})`,0===t.length?e.innerHTML=`<div style="grid-column:1/-1;color:var(--muted);padding:12px">No hay productos.</div>`:t.forEach(t=>{const o=isOffer(t),a=isOut(t),r=document.createElement("article");r.className="card",r.dataset.pid=t.id;const d=a?`<button class="btnDisabled" disabled>Agotado</button>`:`<button class="btnPrimary btnDetails" type="button" data-pid="${t.id}">Ver detalles</button>`;r.innerHTML=`${o?`<div class="tagOffer">OFERTA</div>`:""}<img src="${t.imagen||""}" alt=""><div class="cardBody"><div class="cardTitle">${t.nombre}</div><div class="cardDesc">${t.descripcion||t.subcategoria||""}</div><div class="pr"><div class="p">${money(t.precio)}</div>${o?`<div class="o">${money(t.precio_anterior)}</div>`:""}</div>${d}</div>${a?`<div class="tagOut">AGOTADO</div>`:""}`;const i=r.querySelector(".btnDetails");i&&(i.onclick=(e=>{e.stopPropagation(),openProduct(i.dataset.pid)})),a||r.addEventListener("click",(e=>{if(e.target.closest("button"))return;openProduct(t.id)})),e.appendChild(r)})}function parseGallery(e){const t=[];e.imagen&&t.push(e.imagen);for(let o=1;o<=8;o++){const a="galeria_"+o;e[a]&&t.push(e[a])}return e.galeria&&String(e.galeria).split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>t.push(e)),[...new Set(t.filter(Boolean))].slice(0,8)}function videoLabel(e){const t=(e||"").toLowerCase();return t.includes("tiktok.com")?"Ver en TikTok":t.includes("youtube.com")||t.includes("youtu.be")?"Ver en YouTube":t.includes("facebook.com")||t.includes("fb.watch")?"Ver en Facebook":"Ver video"}function openProduct(e){const t=BY_ID[e];if(!t)return;CURRENT=t,$("modalName").textContent=t.nombre||"Producto",$("modalSub").textContent=`${t.categoria||""}${t.subcategoria?` Â· ${t.subcategoria}`:""}`,$("modalPrice").textContent=money(t.precio||0),$("modalOld").textContent=isOffer(t)?money(t.precio_anterior):"",$("modalDesc").textContent=t.descripcion||"";const o=parseGallery(t);$("modalMainImg").src=o[0]||"";const a=$("modalThumbs");a.innerHTML="",o.length<=1?hide(a):((a.classList.remove("hidden")),o.forEach((e,t)=>{const o=document.createElement("img");o.src=e,o.className=0===t?"active":"",o.onclick=(()=>{$("modalMainImg").src=e,[...a.children].forEach(e=>e.classList.remove("active")),o.classList.add("active")}),a.appendChild(o)}));const r=$("modalVideo");r.innerHTML="";const d=safe(t.video||t.video_url||"");d?(show(r),(()=>{const e=document.createElement("a");e.href=d,e.target="_blank",e.rel="noopener",e.className="videoBtn",e.textContent=videoLabel(d),r.appendChild(e)})()):hide(r),$("modalHint").textContent="";const i=$("btnAddCart");i.disabled=isOut(t),i.textContent=isOut(t)?"Agotado":"Agregar al carrito",openModal("productModal")}function renderCart(){const e=$("cartItems");e.innerHTML="",$("cartEmpty").style.display=CART.length?"none":"block",CART.forEach((t,o)=>{const a=BY_ID[t.id];if(!a)return;const r=document.createElement("div");r.className="cartItem",r.innerHTML=`<img src="${a.imagen||""}" alt=""><div><div class="cartName">${a.nombre}</div><div class="cartMeta">${money(a.precio)} Â· Cantidad: ${t.qty}</div><div class="qtyRow"><button class="minus">-</button><span class="qtyNum">${t.qty}</span><button class="plus">+</button><button class="trash">ðŸ—‘ Eliminar</button></div></div>`,r.querySelector(".minus").onclick=(()=>{t.qty=Math.max(1,t.qty-1),saveCart(),renderCart(),updateTotals()}),r.querySelector(".plus").onclick=(()=>{const e=Number(a.stock||0);if(e>0&&t.qty+1>e)return void alert("Stock disponible: "+e);t.qty++,saveCart(),renderCart(),updateTotals()}),r.querySelector(".trash").onclick=(()=>{CART.splice(o,1),saveCart(),renderCart(),updateTotals()}),e.appendChild(r)}),updateTotals()}function updateTotals(){const e=cartSubtotal();$("subTotal").textContent=money(e),$("shipTotal").textContent=money(0),$("grandTotal").textContent=money(e)}function setStep(e){STEP=e,$("step1").classList.toggle("hidden",1!==e),$("step2").classList.toggle("hidden",2!==e),$("step3").classList.toggle("hidden",3!==e),$("tab1").classList.toggle("active",1===e),$("tab2").classList.toggle("active",2===e),$("tab3").classList.toggle("active",3===e),$("btnBack").style.display=1===e?"none":"inline-block",$("btnNext").textContent=3===e?"Enviar por WhatsApp":"Continuar",$("btnSendWA").style.display=3===e?"block":"none"}function openCart(){setStep(1),renderCart(),openModal("cartModal")}function sendWhatsApp(){if(!CART.length)return void alert("Carrito vacÃ­o");const e=safe($("custName").value),t=safe($("custPhone").value),o=safe($("custAddr").value),a=[];a.push("ðŸ›’ PEDIDO - SDC"),a.push(""),e&&a.push("ðŸ‘¤ "+e),t&&a.push("ðŸ“ž "+t),o&&a.push("ðŸ“ "+o),a.push(""),a.push("Productos:"),CART.forEach(e=>{const t=BY_ID[e.id];t&&a.push(`- ${e.qty} x ${t.nombre} (${money(t.precio)})`)}),a.push(""),a.push("Total: "+money(cartSubtotal())),window.open(`https://wa.me/${WA}?text=${encodeURIComponent(a.join("\n"))}`,"_blank")}function wire(){ $("overlay").onclick=(()=>{closeModal("productModal"),closeModal("cartModal")}),$("closeProduct").onclick=(()=>closeModal("productModal")),$("closeCart").onclick=(()=>closeModal("cartModal")),$("btnKeepBuying").onclick=(()=>closeModal("productModal")),$("btnGoPay").onclick=(()=>{closeModal("productModal"),openCart()}),$("btnAddCart").onclick=(()=>{if(!CURRENT||isOut(CURRENT))return;let e=CART.find(e=>e.id===CURRENT.id);e?e.qty++:CART.push({id:CURRENT.id,qty:1}),saveCart(),$("modalHint").textContent="âœ… Agregado. Puedes seguir comprando o ir a pagar."}),$("tab1").onclick=(()=>setStep(1)),$("tab2").onclick=(()=>setStep(2)),$("tab3").onclick=(()=>setStep(3)),$("btnBack").onclick=(()=>{STEP>1&&setStep(STEP-1)}),$("btnNext").onclick=(()=>{if(1===STEP){if(!CART.length)return void alert("Tu carrito estÃ¡ vacÃ­o.");return void setStep(2)}if(2===STEP){const e=safe($("custName").value),t=safe($("custAddr").value);if(e.length<3)return void alert("Escribe tu nombre");if(t.length<6)return void alert("Escribe tu direcciÃ³n");return void setStep(3)}3===STEP&&sendWhatsApp()}),$("btnSendWA").onclick=sendWhatsApp,$("goTop").onclick=(()=>window.scrollTo({top:0,behavior:"smooth"})),$("searchBtn").onclick=(()=>$("searchInput").focus()),$("themeBtn").onclick=toggleTheme,$("cartBtn").onclick=openCart,$("searchInput").addEventListener("input",(e=>{QUERY=e.target.value||"",renderProducts()}))}async function init(){applyTheme(),loadCart(),$("loadingMsg").style.display="block";try{DATA=await loadAPI(),PRODUCTS=(DATA.productos||[]).map(e=>({id:safe(e.id),nombre:safe(e.nombre),precio:Number(e.precio||0),precio_anterior:Number(e.precio_anterior||0),stock:Number(e.stock||0),categoria:safe(e.categoria||"General")||"General",subcategoria:safe(e.subcategoria||""),descripcion:safe(e.descripcion||""),imagen:safe(e.imagen||""),orden:Number(e.orden||999999),video:safe(e.video||e.video_url||""),galeria:safe(e.galeria||""),galeria_1:safe(e.galeria_1||""),galeria_2:safe(e.galeria_2||""),galeria_3:safe(e.galeria_3||""),galeria_4:safe(e.galeria_4||""),galeria_5:safe(e.galeria_5||""),galeria_6:safe(e.galeria_6||""),galeria_7:safe(e.galeria_7||""),galeria_8:safe(e.galeria_8||"")})).filter(e=>e.id&&e.nombre),BY_ID={},PRODUCTS.forEach(e=>BY_ID[e.id]=e),renderCategories(),renderSubcategories(),renderProducts(),wire()}catch(e){console.error(e),$("productsGrid").innerHTML=`<div style="grid-column:1/-1;color:var(--muted);padding:12px">Error cargando catÃ¡logo: ${String(e.message||e)}</div>`}finally{$("loadingMsg").style.display="none"}}document.addEventListener("DOMContentLoaded",init);
})();
