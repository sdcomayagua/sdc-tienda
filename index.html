<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Soluciones Digitales Comayagua | CatÃ¡logo</title>

<style>
/* ===========================
   SDC 2026 - SINGLE FILE
   =========================== */

:root{
  --bg:#0b0f19;
  --card:#111a2e;
  --card2:#0f172a;
  --text:#e7eefc;
  --muted:#9fb2d6;
  --primary:#0b57ff;
  --danger:#ff2f2f;
  --success:#14b86a;
  --soft:#1b2a4d;
  --border:rgba(255,255,255,.12);
  --shadow: 0 12px 28px rgba(0,0,0,.35);
  --radius:18px;
}

body.light{
  --bg:#f6f8ff;
  --card:#ffffff;
  --card2:#ffffff;
  --text:#0b1220;
  --muted:#5a6a87;
  --soft:#e9efff;
  --border:rgba(0,0,0,.12);
  --shadow: 0 12px 24px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

a{color:inherit}

/* ===== Topbar ===== */
.topbar{
  position:sticky; top:0; z-index:50;
  display:flex; gap:10px;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  backdrop-filter: blur(10px);
}
body.light .topbar{
  background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,0));
}

.brand{
  display:flex; align-items:center; gap:10px;
  min-width:0;
  cursor:pointer;
}
.logo{
  width:42px; height:42px;
  border-radius:14px;
  display:grid; place-items:center;
  background:var(--primary);
  color:#fff;
  font-weight:1000;
  letter-spacing:.5px;
  flex:0 0 auto;
}

.brandText{min-width:0; display:flex; flex-direction:column}
#storeName{
  font-weight:1000;
  line-height:1.1;
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:520px;
  text-decoration:none;
}
#storeSub{
  color:var(--muted);
  font-size:12px;
  margin-top:2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:520px;
}

@media (max-width: 720px){
  #storeName{
    max-width: 56vw;
    color: transparent;
    position: relative;
    font-size: 16px;
  }
  #storeName::after{
    content:"SDComayagua";
    color: var(--text);
    position:absolute;
    left:0; top:0;
    white-space:nowrap;
  }
  #storeSub{ font-size:11px; opacity:.9; max-width:56vw; }
}
@media (max-width: 420px){
  #storeName{ max-width: 50vw; }
  .logo{ width:38px; height:38px; border-radius:12px; }
}

.topActions{display:flex; gap:10px; align-items:center; flex:0 0 auto;}
.iconBtn{
  width:42px; height:42px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  box-shadow: var(--shadow);
  font-size:16px;
  cursor:pointer;
}
.cartBtn{
  position:relative;
  height:42px;
  padding:0 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  box-shadow: var(--shadow);
  font-weight:1000;
  cursor:pointer;
}
.badge{
  display:inline-grid; place-items:center;
  min-width:22px; height:22px;
  padding:0 6px;
  border-radius:999px;
  background:var(--primary);
  color:#fff;
  font-size:12px;
  margin-left:6px;
}

/* ===== Loading header ===== */
.loadingWrap{
  text-align:center;
  padding:18px 12px 2px;
}
.loadingTitle{
  font-weight:1000;
  font-size:18px;
}
.loadingSub{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.spinner{
  width:34px; height:34px;
  border-radius:999px;
  margin:12px auto 8px;
  border:3px solid rgba(255,255,255,.12);
  border-top-color: rgba(11,87,255,.9);
  animation: spin .9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Chips ===== */
.chips, .subchips{
  display:flex; gap:10px;
  overflow:auto;
  padding:10px 12px 12px;
  scrollbar-width:none;
}
.chips::-webkit-scrollbar,.subchips::-webkit-scrollbar{display:none}
.chip{
  white-space:nowrap;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  box-shadow: var(--shadow);
  font-weight:1000;
  font-size:13px;
  cursor:pointer;
  user-select:none;
}
.chip.active{background:var(--primary); border-color:transparent; color:#fff}
.subchips{
  margin-top:-10px;
  padding-top:0;
  padding-bottom:10px;
}
.subchips .chip{
  padding:8px 12px;
  font-size:12px;
  box-shadow:none;
  background: rgba(255,255,255,.04);
}
body.light .subchips .chip{ background: rgba(0,0,0,.04); }
.subchips .chip.active{
  background: rgba(11,87,255,.18);
  border-color: rgba(11,87,255,.45);
  color: var(--text);
}

/* ===== Search + Section ===== */
.searchWrap{padding:8px 12px 12px;}
.search{
  width:100%;
  padding:14px 14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  outline:none;
  box-shadow: var(--shadow);
}
.sectionHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:0 12px;
  margin-top:8px;
}
.sectionTitle{
  font-weight:1000;
  font-size:16px;
}

/* ===== Grid ===== */
.gridWrap{padding:10px 12px 18px;}
.grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (min-width: 840px){
  .grid{grid-template-columns: repeat(4, minmax(0, 1fr));}
}

.card{
  border:1px solid var(--border);
  background:var(--card);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  position:relative;
  cursor:pointer;
}
.cardImg{
  width:100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  display:block;
  background:var(--card2);
}
.cardBody{padding:12px;}
.cardName{font-weight:1000; font-size:13px; line-height:1.25;}
.cardDesc{color:var(--muted); font-size:12px; margin-top:6px; min-height:30px;}
.priceRow{display:flex; gap:8px; align-items:baseline; margin-top:10px;}
.price{font-weight:1000;}
.price.offer{color:var(--danger);}
.old{color:var(--muted); text-decoration:line-through; font-size:12px;}
.cardActions{display:flex; gap:10px; margin-top:10px;}

.btn{
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  padding:12px 14px;
  border-radius:16px;
  font-weight:1000;
  cursor:pointer;
}
.btnSoft{background:var(--soft);}
.btnPrimary{background:var(--primary); border-color:transparent; color:#fff;}
.btnDanger{background:rgba(255,47,47,.14); border-color:rgba(255,47,47,.35); color:var(--danger);}
.btnFull{width:100%}
.btnMini{padding:9px 10px; border-radius:12px; font-size:12px;}
.btnRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

.offerTag{
  position:absolute;
  top:10px; left:10px;
  background:rgba(255,47,47,.14);
  border:1px solid rgba(255,47,47,.35);
  color:var(--danger);
  font-weight:1000;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
}

/* Agotado: gris + watermark completo */
.card.out{
  filter: grayscale(1);
  opacity:.82;
}
.watermark{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  pointer-events:none;
  font-weight:1000;
  font-size: clamp(18px, 7vw, 44px);
  letter-spacing: 2px;
  transform: rotate(-18deg);
  color: rgba(255,0,0,.35);
  text-transform:uppercase;
  text-align:center;
  padding:10px;
}

/* WhatsApp */
.waFloat{
  position:fixed; right:16px; bottom:16px; z-index:25;
  padding:14px 14px;
  border-radius:999px;
  background:#25D366;
  color:#fff;
  font-weight:1000;
  text-decoration:none;
  box-shadow: var(--shadow);
}

/* ===== Modal ===== */
.modalBackdrop{
  position:fixed; inset:0; z-index:80;
  background:rgba(0,0,0,.58);
  display:none;
}
.modal{
  position:fixed; inset:auto 12px 12px 12px; z-index:90;
  max-width:860px; margin:0 auto;
  border:1px solid var(--border);
  background:var(--card);
  border-radius:22px;
  box-shadow: var(--shadow);
  display:none;
  max-height: 88vh;
  overflow:hidden;
}
@media (min-width: 860px){
  .modal{ inset:auto 0 18px 0; }
}
.modalHeader{
  display:flex; align-items:flex-start; justify-content:space-between;
  padding:14px 14px;
  border-bottom:1px solid var(--border);
  gap:10px;
}
.modalTitle{font-weight:1000; font-size:18px; line-height:1.1;}
.modalSub{color:var(--muted); font-size:12px; margin-top:3px}
.modalBody{padding:12px 14px; overflow:auto; max-height: calc(88vh - 140px);}
.modalFooter{
  display:flex; gap:10px; flex-wrap:wrap;
  padding:12px 14px;
  border-top:1px solid var(--border);
}
.modalFooter .btn{flex:1}
.closeBtn{
  width:42px; height:42px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:18px;
  cursor:pointer;
}

/* Product modal */
.prodWrap{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}
@media (min-width: 860px){
  .prodWrap{ grid-template-columns: 1fr 1fr; }
}
.prodMainImg{
  width:100%;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--card2);
  aspect-ratio: 1 / 1;
  object-fit: cover;
}
.thumbs{
  display:flex; gap:10px;
  overflow:auto; padding:10px 0 6px;
  scrollbar-width:none;
}
.thumbs::-webkit-scrollbar{display:none}
.thumb{
  width:64px; height:64px;
  border-radius:14px;
  border:1px solid var(--border);
  object-fit:cover;
  flex:0 0 auto;
  opacity:.85;
  cursor:pointer;
}
.thumb.active{opacity:1; outline:2px solid rgba(11,87,255,.35);}
.prodMeta{
  color:var(--muted);
  margin-top:10px;
  line-height:1.35;
  font-size:13px;
  white-space:pre-wrap;
}
.videoBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
.vbtn{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--soft);
  color:var(--text);
  font-weight:1000;
  text-decoration:none;
}
.hr{height:1px; background:var(--border); margin:12px 0}

/* Cart list */
.cartEmpty{
  padding:12px;
  border:1px dashed var(--border);
  border-radius:16px;
  color:var(--muted);
}
.cartList{display:flex; flex-direction:column; gap:10px; margin-top:12px;}
.cartItem{
  display:grid;
  grid-template-columns: 64px 1fr;
  gap:10px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card2);
}
.cartItemImg{
  width:64px; height:64px;
  border-radius:14px;
  object-fit:cover;
  border:1px solid var(--border);
  background:var(--card);
}
.cartItemName{font-weight:1000; font-size:13px; line-height:1.2}
.cartItemMeta{color:var(--muted); font-size:12px; margin-top:4px}

.qtyRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.qtyCtrls{
  display:flex; align-items:center; gap:8px;
}
.qtyBtn{
  width:38px; height:38px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-weight:1000;
  cursor:pointer;
}
.qtyNum{min-width:26px; text-align:center; font-weight:1000}
.trashBtn{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,47,47,.35);
  background:rgba(255,47,47,.12);
  color:var(--danger);
  font-weight:1000;
  cursor:pointer;
}

.totals{
  margin-top:12px;
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px 12px;
  background:var(--card2);
}
.totals .row{
  display:flex; justify-content:space-between;
  padding:6px 0;
  color:var(--muted);
  gap:10px;
}
.totals .row.total{
  color:var(--text);
  font-weight:1000;
  border-top:1px solid var(--border);
  margin-top:8px;
  padding-top:10px;
}
.hint{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35}

/* Form */
.form{
  display:grid;
  gap:10px;
}
.field label{
  display:block;
  font-weight:900;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}
.input, .select, textarea{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  outline:none;
}
textarea{min-height:72px; resize:vertical}
.smallMuted{color:var(--muted); font-size:12px}

/* Skeleton */
.skelGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (min-width: 840px){
  .skelGrid{grid-template-columns: repeat(4, minmax(0, 1fr));}
}
.skelCard{
  border:1px solid var(--border);
  background:var(--card);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.skelImg{
  width:100%;
  aspect-ratio: 1 / 1;
  background:var(--card2);
  position:relative;
  overflow:hidden;
}
.skelBody{padding:12px;}
.skelLine{
  height:12px;
  border-radius:10px;
  background:var(--card2);
  margin-top:10px;
  position:relative;
  overflow:hidden;
}
.skelLine.sm{width:60%}
.skelLine.md{width:85%}
.skelLine.lg{width:95%}
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}
.skelImg::after,
.skelLine::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.08), rgba(255,255,255,0));
  transform: translateX(-100%);
  animation: shimmer 1.1s infinite;
}
</style>
</head>

<body>

<!-- ===== Topbar ===== -->
<header class="topbar">
  <div class="brand" id="brandHome" title="Ir al inicio">
    <div class="logo" id="logoText">SDC</div>
    <div class="brandText">
      <a id="storeName" href="javascript:void(0)">Soluciones Digitales Comayagua</a>
      <div id="storeSub">CatÃ¡logo</div>
    </div>
  </div>

  <div class="topActions">
    <button class="iconBtn" id="btnTheme" title="DÃ­a/Noche">ðŸŒ™</button>
    <button class="iconBtn" id="btnSearch" title="Buscar">ðŸ”Ž</button>
    <button class="cartBtn" id="btnCart" title="Carrito">
      ðŸ›’ <span class="badge" id="cartCount">0</span>
    </button>
  </div>
</header>

<!-- ===== Loading placeholder (solo primera vez) ===== -->
<div id="loadingBlock" class="loadingWrap" style="display:none">
  <div class="spinner"></div>
  <div class="loadingTitle">Cargando catÃ¡logoâ€¦</div>
  <div class="loadingSub">Un momento por favor</div>
</div>

<!-- ===== Chips ===== -->
<nav class="chips" id="chips"></nav>
<nav class="subchips" id="subchips" style="display:none"></nav>

<!-- ===== Search ===== -->
<div class="searchWrap">
  <input class="search" id="searchInput" placeholder="Buscar productos, nombre o descripciÃ³nâ€¦" />
</div>

<div class="sectionHeader">
  <div class="sectionTitle" id="sectionTitle">Productos</div>
  <div class="btnRow">
    <button class="btn btnMini" id="btnShareCategory" style="display:none">ðŸ”— Compartir</button>
    <button class="btn btnMini" id="btnShareSub" style="display:none">ðŸ”— Sub</button>
  </div>
</div>

<!-- ===== Grid ===== -->
<div class="gridWrap">
  <div class="grid" id="grid"></div>
</div>

<!-- ===== WhatsApp Float ===== -->
<a class="waFloat" id="waFloat" href="#" target="_blank" rel="noopener">WhatsApp</a>

<!-- ===========================
     PRODUCT MODAL
=========================== -->
<div class="modalBackdrop" id="backdrop"></div>

<div class="modal" id="prodModal" aria-hidden="true">
  <div class="modalHeader">
    <div>
      <div class="modalTitle" id="modalName">Producto</div>
      <div class="modalSub" id="modalSub">â€”</div>
    </div>
    <button class="closeBtn" id="prodClose" aria-label="Cerrar">âœ•</button>
  </div>

  <div class="modalBody">
    <div class="prodWrap">
      <div>
        <img class="prodMainImg" id="modalMainImg" src="" alt="">
        <div class="thumbs" id="modalThumbs" style="display:none"></div>
      </div>
      <div>
        <div class="priceRow" style="margin-top:2px">
          <div class="price" id="modalPrice">Lps. 0</div>
          <div class="old" id="modalOld"></div>
        </div>
        <div class="prodMeta" id="modalDesc"></div>
        <div class="videoBtns" id="modalVideos" style="display:none"></div>
        <div class="hr"></div>
        <button class="btn btnPrimary btnFull" id="btnAddCart">Agregar al carrito</button>
        <div class="hint" id="modalHint"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     CART MODAL (3 pasos)
=========================== -->
<div class="modal" id="cartModal" aria-hidden="true">
  <div class="modalHeader">
    <div>
      <div class="modalTitle">Carrito</div>
      <div class="modalSub" id="cartSub">Revisa tu pedido</div>
    </div>
    <button class="closeBtn" id="cartClose" aria-label="Cerrar">âœ•</button>
  </div>

  <div class="modalBody">
    <div id="cartStep1">
      <div id="cartEmpty" class="cartEmpty" style="display:none">Tu carrito estÃ¡ vacÃ­o.</div>
      <div class="cartList" id="cartList"></div>

      <div class="totals">
        <div class="row"><span>Subtotal</span><span id="cartSubtotal">Lps. 0</span></div>
        <div class="row"><span>EnvÃ­o / Entrega</span><span id="cartShip">Lps. 0</span></div>
        <div class="row total"><span>Total</span><span id="cartTotal">Lps. 0</span></div>
      </div>

      <div class="hint">Luego toca <b>Continuar</b> para elegir entrega y pago.</div>
    </div>

    <div id="cartStep2" style="display:none">
      <div class="form">

        <div class="field">
          <label>Â¿DÃ³nde estÃ¡s?</label>
          <select class="select" id="locType">
            <option value="comayagua">En Comayagua (entrega local)</option>
            <option value="fuera">Otro departamento (envÃ­o)</option>
          </select>
          <div class="smallMuted" id="locHelp"></div>
        </div>

        <div id="comayaguaBlock">
          <div class="field">
            <label>Zona / Municipio (entrega local)</label>
            <select class="select" id="localZone"></select>
            <div class="smallMuted" id="zoneExamples"></div>
          </div>

          <div class="field">
            <label>MÃ©todo de pago (Comayagua)</label>
            <select class="select" id="payLocal">
              <option value="efectivo">Pagar al recibir (efectivo)</option>
              <option value="transferencia">Transferencia bancaria</option>
              <option value="paypal">PayPal</option>
              <option value="tigo">Tigo Money</option>
            </select>
          </div>

          <div class="field" id="cashBlock">
            <label>Â¿Con cuÃ¡nto pagarÃ¡s? (Cambio estimado)</label>
            <input class="input" id="cashWith" inputmode="numeric" placeholder="Ej: 1000" />
            <div class="smallMuted" id="cashChange"></div>
          </div>

          <div class="field" id="bankBlock" style="display:none">
            <label>Elige el banco</label>
            <select class="select" id="bankSelect"></select>
            <div class="smallMuted" id="bankInfo"></div>
          </div>

          <div class="field" id="paypalBlock" style="display:none">
            <label>PayPal</label>
            <div class="smallMuted" id="paypalInfo"></div>
          </div>

          <div class="field" id="tigoBlock" style="display:none">
            <label>Tigo Money</label>
            <div class="smallMuted" id="tigoInfo"></div>
          </div>
        </div>

        <div id="fueraBlock" style="display:none">
          <div class="field">
            <label>Departamento</label>
            <select class="select" id="deptSelect"></select>
          </div>
          <div class="field">
            <label>Municipio</label>
            <select class="select" id="muniSelect"></select>
          </div>

          <div class="field">
            <label>Tipo de envÃ­o</label>
            <select class="select" id="shipType">
              <option value="empresa">Empresa (Cargo/Forza/C807)</option>
              <option value="bus">Bus / encomienda (rango)</option>
            </select>
            <div class="smallMuted" id="shipTypeHelp"></div>
          </div>

          <div id="empresaBlock">
            <div class="field">
              <label>Empresa</label>
              <select class="select" id="courierSelect"></select>
            </div>
            <div class="field">
              <label>Servicio</label>
              <select class="select" id="courierService">
                <option value="normal">Normal (pago anticipado)</option>
                <option value="cod">Contra entrega (pagar al recibir)</option>
              </select>
            </div>
            <div class="smallMuted" id="courierInfo"></div>

            <div class="field">
              <label>MÃ©todo de pago</label>
              <select class="select" id="payFuera">
                <option value="transferencia">Transferencia bancaria</option>
                <option value="paypal">PayPal</option>
                <option value="tigo">Tigo Money</option>
                <option value="cod">Pagar al recibir (contra entrega)</option>
              </select>
            </div>

            <div class="field" id="bankBlock2">
              <label>Elige el banco</label>
              <select class="select" id="bankSelect2"></select>
              <div class="smallMuted" id="bankInfo2"></div>
            </div>

            <div class="field" id="paypalBlock2" style="display:none">
              <label>PayPal</label>
              <div class="smallMuted" id="paypalInfo2"></div>
            </div>

            <div class="field" id="tigoBlock2" style="display:none">
              <label>Tigo Money</label>
              <div class="smallMuted" id="tigoInfo2"></div>
            </div>
          </div>

          <div id="busBlock" style="display:none">
            <div class="field">
              <label>Encomienda por bus (rango)</label>
              <div class="smallMuted" id="busInfo"></div>
            </div>
            <div class="field">
              <label>MÃ©todo de pago</label>
              <select class="select" id="payBus">
                <option value="transferencia">Transferencia bancaria</option>
                <option value="paypal">PayPal</option>
                <option value="tigo">Tigo Money</option>
              </select>
            </div>

            <div class="field" id="bankBlock3">
              <label>Elige el banco</label>
              <select class="select" id="bankSelect3"></select>
              <div class="smallMuted" id="bankInfo3"></div>
            </div>

            <div class="field" id="paypalBlock3" style="display:none">
              <label>PayPal</label>
              <div class="smallMuted" id="paypalInfo3"></div>
            </div>

            <div class="field" id="tigoBlock3" style="display:none">
              <label>Tigo Money</label>
              <div class="smallMuted" id="tigoInfo3"></div>
            </div>
          </div>
        </div>

        <div class="field">
          <label>Nombre y apellido</label>
          <input class="input" id="custName" placeholder="Ej: Juan PÃ©rez" />
        </div>
        <div class="field">
          <label>DirecciÃ³n / Referencias</label>
          <textarea id="custAddr" placeholder="Ej: Barrio, colonia, referencia, punto exacto..."></textarea>
        </div>
        <div class="field">
          <label>TelÃ©fono (opcional)</label>
          <input class="input" id="custPhone" inputmode="tel" placeholder="Ej: +504 ..." />
        </div>

      </div>
    </div>

    <div id="cartStep3" style="display:none">
      <div class="hint" style="margin-top:0">
        Revisa el resumen y envÃ­a el pedido por WhatsApp.
      </div>
      <div class="totals" style="margin-top:10px">
        <div class="row"><span>Subtotal</span><span id="sumSubtotal">Lps. 0</span></div>
        <div class="row"><span>EnvÃ­o/Entrega</span><span id="sumShip">Lps. 0</span></div>
        <div class="row total"><span>Total</span><span id="sumTotal">Lps. 0</span></div>
      </div>
      <div class="hint" id="sumDetails"></div>
    </div>
  </div>

  <div class="modalFooter">
    <button class="btn btnSoft" id="cartBack">AtrÃ¡s</button>
    <button class="btn btnPrimary" id="cartNext">Continuar</button>
  </div>
</div>

<script>
/* ===========================
   CONFIG
=========================== */
const API_URL = "https://script.google.com/macros/s/AKfycbytPfD9mq__VO7I2lnpBsqdCIT119ZT0zVyz0eeVjrJVgN_q8FYGgmqY6G66C2m67Pa4g/exec";
const WA_NUMBER_DEFAULT = "50431517755";

/* cache local */
const CACHE_KEY = "sdc_api_cache_v4";
const CACHE_TTL_MS = 5 * 60 * 1000;

/* ===========================
   STATE
=========================== */
let DB = { productos: [], categorias: [], ajustes: [], envios: [] };
let STATE = {
  categoria: "Todas",
  subcategoria: "Todas",
  query: "",
  openedProduct: null
};

const CART_KEY = "sdc_cart_v1";
let CART = []; // [{id, qty}]

/* ===========================
   HELPERS
=========================== */
const $ = (id)=>document.getElementById(id);

function fmtLps(n){
  const v = Number(n||0);
  return `Lps. ${Math.round(v).toLocaleString("es-HN")}`;
}
function clampStr(s, max=160){
  const t = String(s||"");
  return t.length>max ? t.slice(0,max-1)+"â€¦" : t;
}
function safeText(s){
  return String(s||"").replace(/[<>&]/g, c=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[c]));
}
function normalizeProduct(p){
  const out = {
    id: String(p.id||"").trim(),
    nombre: String(p.nombre||"").trim(),
    precio: Number(p.precio||0),
    precio_anterior: Number(p.precio_anterior||0),
    stock: Number(p.stock||0),
    categoria: String(p.categoria||"General").trim() || "General",
    subcategoria: String(p.subcategoria||"").trim(),
    imagen: String(p.imagen||"").trim(),
    descripcion: String(p.descripcion||"").trim(),
    orden: Number(p.orden||0),
    video: String(p.video||p.video_url||"").trim(),
  };

  // galeria_1..8 o "galeria" con coma
  if (p.galeria && !p.galeria_1){
    const parts = String(p.galeria).split(",").map(s=>s.trim()).filter(Boolean);
    for(let i=1;i<=8;i++) out[`galeria_${i}`] = parts[i-1] || "";
  } else {
    for(let i=1;i<=8;i++) out[`galeria_${i}`] = String(p[`galeria_${i}`]||"").trim();
  }

  return out;
}

function ajustesMap(){
  const map = {};
  (DB.ajustes||[]).forEach(r=>{
    const k = String(r.clave||"").trim();
    const v = String(r.valor||"").trim();
    if (k) map[k]=v;
  });
  return map;
}

function setTheme(next){
  document.body.classList.toggle("light", next === "light");
  localStorage.setItem("sdc_theme", next);
  $("btnTheme").textContent = next === "light" ? "ðŸŒ™" : "â˜€ï¸";
}

/* ===========================
   API + CACHE
=========================== */
function getCached(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.t || !obj.data) return null;
    if(Date.now()-obj.t > CACHE_TTL_MS) return null;
    return obj.data;
  }catch{ return null; }
}
function setCached(data){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), data})) }catch{}
}

async function fetchWithTimeout(url, ms=12000){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), ms);
  try{
    return await fetch(url, {cache:"no-store", signal: controller.signal});
  } finally { clearTimeout(timer); }
}

async function apiGetAll(){
  const cached = getCached();
  if(cached){
    // refrescar detrÃ¡s
    fetchWithTimeout(API_URL, 12000)
      .then(r=>r.ok ? r.json() : null)
      .then(j=>{ if(j) setCached(j); })
      .catch(()=>{});
    return cached;
  }
  const res = await fetchWithTimeout(API_URL, 12000);
  if(!res.ok) throw new Error(`API HTTP ${res.status}`);
  const data = await res.json();
  setCached(data);
  return data;
}

/* ===========================
   CATEGORIES + SUBCATEGORIES
=========================== */
function getCategoriasBase(){
  // si hay DB.categorias, Ãºsala; si no, deriva de productos
  let cats = [];
  if(DB.categorias && DB.categorias.length){
    cats = DB.categorias
      .filter(c => String(c.visible ?? 1) === "1" || c.visible === 1)
      .sort((a,b)=>Number(a.orden||0)-Number(b.orden||0))
      .map(c=>String(c.categoria||"").trim())
      .filter(Boolean);
  } else {
    cats = Array.from(new Set(DB.productos.map(p=>p.categoria)))
      .filter(Boolean)
      .sort((a,b)=>a.localeCompare(b));
  }
  // inyecta OFERTAS al inicio (si hay ofertas)
  const hasOffers = DB.productos.some(p=>Number(p.precio_anterior||0) > Number(p.precio||0));
  const head = ["Todas"];
  if(hasOffers) head.push("OFERTAS");
  return [...head, ...cats.filter(c=>c!=="Todas" && c!=="OFERTAS")];
}

function getSubcategorias(cat){
  if(!cat || cat==="Todas" || cat==="OFERTAS"){
    return [];
  }
  const subs = Array.from(new Set(DB.productos
    .filter(p=>p.categoria===cat)
    .map(p=>String(p.subcategoria||"").trim())
    .filter(Boolean)
  )).sort((a,b)=>a.localeCompare(b));

  return subs;
}

/* ===========================
   SHARE LINKS + DOUBLE TAP
=========================== */
function copyToClipboard(text){
  return navigator.clipboard.writeText(text);
}
function shareUrlFor(cat, sub){
  const base = location.origin + location.pathname;
  const params = [];
  if(cat && cat!=="Todas") params.push("cat="+encodeURIComponent(cat));
  if(sub && sub!=="Todas") params.push("sub="+encodeURIComponent(sub));
  return base + (params.length ? "#"+params.join("&") : "#");
}

// double-tap helper (mobile friendly)
function makeTapHandler(onSingle, onDouble){
  let last = 0;
  return function(){
    const now = Date.now();
    if(now - last < 380){
      last = 0;
      onDouble && onDouble();
    } else {
      last = now;
      setTimeout(()=>{ if(last && Date.now()-last >= 380){ last=0; onSingle && onSingle(); } }, 400);
    }
  }
}

/* ===========================
   RENDER CHIPS
=========================== */
function renderCategorias(){
  const chips = $("chips");
  chips.innerHTML = "";

  const cats = getCategoriasBase();

  cats.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "chip" + (STATE.categoria===cat ? " active" : "");
    b.textContent = cat;

    b.addEventListener("click", makeTapHandler(
      ()=>{ // single
        STATE.categoria = cat;
        STATE.subcategoria = "Todas";
        STATE.query = "";
        $("searchInput").value = "";
        renderCategorias();
        renderSubcategorias();
        renderProductos();
        updateShareButtons();
        applyHashFromState(true);
      },
      async ()=>{ // double: copy
        const url = shareUrlFor(STATE.categoria, "Todas");
        try{ await copyToClipboard(url); alert("Enlace copiado"); }
        catch{ alert("No se pudo copiar"); }
      }
    ));

    chips.appendChild(b);
  });
}

function renderSubcategorias(){
  const wrap = $("subchips");
  const subs = getSubcategorias(STATE.categoria);

  if(!subs.length){
    wrap.style.display = "none";
    wrap.innerHTML = "";
    return;
  }

  wrap.style.display = "flex";
  wrap.innerHTML = "";

  const all = document.createElement("button");
  all.className = "chip" + (STATE.subcategoria==="Todas" ? " active" : "");
  all.textContent = "Todas";
  all.addEventListener("click", makeTapHandler(
    ()=>{ STATE.subcategoria="Todas"; renderSubcategorias(); renderProductos(); updateShareButtons(); applyHashFromState(true); },
    async ()=>{ const url = shareUrlFor(STATE.categoria, "Todas"); try{ await copyToClipboard(url); alert("Enlace copiado"); }catch{ alert("No se pudo copiar"); } }
  ));
  wrap.appendChild(all);

  subs.forEach(sub=>{
    const b = document.createElement("button");
    b.className = "chip" + (STATE.subcategoria===sub ? " active" : "");
    b.textContent = sub;

    b.addEventListener("click", makeTapHandler(
      ()=>{ STATE.subcategoria=sub; renderSubcategorias(); renderProductos(); updateShareButtons(); applyHashFromState(true); },
      async ()=>{ const url = shareUrlFor(STATE.categoria, sub); try{ await copyToClipboard(url); alert("Enlace copiado"); }catch{ alert("No se pudo copiar"); } }
    ));

    wrap.appendChild(b);
  });
}

function updateShareButtons(){
  $("btnShareCategory").style.display = (STATE.categoria==="Todas") ? "none" : "inline-flex";
  $("btnShareSub").style.display = (STATE.categoria!=="Todas" && STATE.subcategoria!=="Todas") ? "inline-flex" : "none";
}

/* ===========================
   FILTER + SORT
=========================== */
function filteredProductos(){
  const q = STATE.query.trim().toLowerCase();

  let list = DB.productos.slice();

  // categorÃ­a
  if(STATE.categoria==="OFERTAS"){
    list = list.filter(p=>Number(p.precio_anterior||0) > Number(p.precio||0));
  } else if(STATE.categoria!=="Todas"){
    list = list.filter(p=>p.categoria===STATE.categoria);
  }

  // subcategorÃ­a
  if(STATE.subcategoria && STATE.subcategoria!=="Todas"){
    list = list.filter(p=>String(p.subcategoria||"").trim()===STATE.subcategoria);
  }

  // bÃºsqueda
  if(q){
    list = list.filter(p=>{
      return (p.nombre||"").toLowerCase().includes(q) ||
        (p.descripcion||"").toLowerCase().includes(q) ||
        (p.subcategoria||"").toLowerCase().includes(q) ||
        (p.categoria||"").toLowerCase().includes(q);
    });
  }

  // sort: disponibles primero, luego orden, luego nombre
  list.sort((a,b)=>{
    const av = a.stock>0 ? 0 : 1;
    const bv = b.stock>0 ? 0 : 1;
    if(av!==bv) return av-bv;

    const ao = Number(a.orden||0);
    const bo = Number(b.orden||0);
    if(ao!==bo) return ao-bo;

    return (a.nombre||"").localeCompare(b.nombre||"");
  });

  return list;
}

/* ===========================
   PRODUCT CARD
=========================== */
function productCard(p){
  const card = document.createElement("div");
  const isOut = Number(p.stock||0) <= 0;
  const isOffer = Number(p.precio_anterior||0) > Number(p.precio||0);

  card.className = "card" + (isOut ? " out" : "");

  const img = p.imagen ? safeText(p.imagen) : "";
  const desc = p.descripcion || p.subcategoria || p.categoria || "";
  const priceClass = isOffer ? "price offer" : "price";

  card.innerHTML = `
    ${isOffer ? `<div class="offerTag">OFERTA</div>` : ``}
    <img class="cardImg" src="${img}" alt="">
    <div class="cardBody">
      <div class="cardName">${safeText(p.nombre||"Producto")}</div>
      <div class="cardDesc">${safeText(clampStr(desc, 90))}</div>
      <div class="priceRow">
        <div class="${priceClass}">${fmtLps(p.precio||0)}</div>
        <div class="old">${isOffer ? fmtLps(p.precio_anterior) : ""}</div>
      </div>
      <div class="cardActions">
        <button class="btn btnPrimary btnFull" ${isOut ? "disabled":""}>
          ${isOut ? "Agotado" : "Ver detalles"}
        </button>
      </div>
    </div>
  `;

  if(isOut){
    const wm = document.createElement("div");
    wm.className = "watermark";
    wm.textContent = "AGOTADO";
    card.appendChild(wm);
  }

  card.addEventListener("click", ()=>{
    openProduct(p);
  });

  return card;
}

/* ===========================
   RENDER PRODUCTS
=========================== */
function renderProductos(){
  const grid = $("grid");
  const list = filteredProductos();

  let title = "Productos";
  if(STATE.categoria==="Todas") title = `Productos (${list.length})`;
  else if(STATE.categoria==="OFERTAS") title = `OFERTAS (${list.length})`;
  else title = `${STATE.categoria} (${list.length})`;

  if(STATE.subcategoria && STATE.subcategoria!=="Todas"){
    title += ` Â· ${STATE.subcategoria}`;
  }

  $("sectionTitle").textContent = title;

  grid.innerHTML = "";
  if(!list.length){
    const empty = document.createElement("div");
    empty.style.color = "var(--muted)";
    empty.style.padding = "10px 2px";
    empty.textContent = (STATE.categoria==="OFERTAS")
      ? "No hay productos en oferta en este momento."
      : "No hay productos para mostrar.";
    grid.appendChild(empty);
    return;
  }
  list.forEach(p=>grid.appendChild(productCard(p)));
}

/* ===========================
   APPLY AJUSTES (Brand + WhatsApp)
=========================== */
function applyAjustes(){
  const a = ajustesMap();

  const name = a["nombre_tienda"] || "Soluciones Digitales Comayagua";
  const sub = a["subtitulo"] || "CatÃ¡logo";
  const sig = a["siglas"] || "SDC";

  $("storeName").textContent = name;
  $("storeSub").textContent = sub;
  $("logoText").textContent = sig;

  const wa = (a["whatsapp_numero"] || WA_NUMBER_DEFAULT).replace(/\D/g,"");
  const msg = a["mensaje_whatsapp"] || "Hola, quiero consultar el catÃ¡logo.";
  $("waFloat").href = `https://wa.me/${wa}?text=${encodeURIComponent(msg)}`;
}

/* ===========================
   MODALS (OPEN/CLOSE) - FIX
=========================== */
function showBackdrop(){
  $("backdrop").style.display = "block";
}
function hideBackdrop(){
  $("backdrop").style.display = "none";
}
function showModal(el){
  showBackdrop();
  el.style.display = "block";
  el.setAttribute("aria-hidden","false");
}
function hideModal(el){
  el.style.display = "none";
  el.setAttribute("aria-hidden","true");
  // si no hay otro modal abierto, quitamos backdrop
  const prodOpen = $("prodModal").style.display === "block";
  const cartOpen = $("cartModal").style.display === "block";
  if(!prodOpen && !cartOpen) hideBackdrop();
}

$("backdrop").addEventListener("click", ()=>{
  // cierra lo que estÃ© abierto
  if($("prodModal").style.display==="block") hideModal($("prodModal"));
  if($("cartModal").style.display==="block") hideModal($("cartModal"));
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    if($("prodModal").style.display==="block") hideModal($("prodModal"));
    if($("cartModal").style.display==="block") hideModal($("cartModal"));
  }
});

/* ===========================
   PRODUCT MODAL (gallery + video)
=========================== */
function openProduct(p){
  STATE.openedProduct = p;

  const modal = $("prodModal");
  $("modalName").textContent = p.nombre || "Producto";
  $("modalSub").textContent = (p.categoria||"â€”") + (p.subcategoria ? " Â· "+p.subcategoria : "");
  $("modalDesc").textContent = p.descripcion || "";
  $("modalPrice").textContent = fmtLps(p.precio||0);

  const oldOk = Number(p.precio_anterior||0) > Number(p.precio||0);
  $("modalOld").textContent = oldOk ? fmtLps(p.precio_anterior) : "";
  $("modalPrice").className = oldOk ? "price offer" : "price";

  // GalerÃ­a
  const urls = [];
  if(p.imagen) urls.push(String(p.imagen).trim());
  for(let i=1;i<=8;i++){
    const g = p[`galeria_${i}`];
    if(g && String(g).trim()) urls.push(String(g).trim());
  }
  const gallery = Array.from(new Set(urls)).slice(0,8);

  $("modalMainImg").src = gallery[0] || "";
  $("modalMainImg").alt = p.nombre || "";

  const thumbs = $("modalThumbs");
  thumbs.innerHTML = "";
  if(gallery.length<=1){
    thumbs.style.display="none";
  } else {
    thumbs.style.display="flex";
    gallery.forEach((src,idx)=>{
      const im = document.createElement("img");
      im.className = "thumb"+(idx===0?" active":"");
      im.src = src;
      im.alt = "thumb";
      im.addEventListener("click",(e)=>{
        e.stopPropagation();
        $("modalMainImg").src = src;
        Array.from(thumbs.children).forEach(x=>x.classList.remove("active"));
        im.classList.add("active");
      });
      thumbs.appendChild(im);
    });
  }

  // Video
  const vids = $("modalVideos");
  vids.innerHTML = "";
  const videoUrl = (p.video || "").trim();
  if(!videoUrl){
    vids.style.display="none";
  } else {
    vids.style.display="flex";
    const a = document.createElement("a");
    a.className = "vbtn";
    a.href = videoUrl;
    a.target = "_blank";
    a.rel = "noopener";
    const u = videoUrl.toLowerCase();
    a.textContent =
      u.includes("tiktok.com") ? "Ver en TikTok" :
      (u.includes("youtube.com") || u.includes("youtu.be")) ? "Ver en YouTube" :
      (u.includes("facebook.com") || u.includes("fb.watch")) ? "Ver en Facebook" :
      "Ver video";
    vids.appendChild(a);
  }

  const isOut = Number(p.stock||0)<=0;
  $("btnAddCart").disabled = isOut;
  $("btnAddCart").textContent = isOut ? "Agotado" : "Agregar al carrito";

  $("modalHint").textContent = isOut ? "Este producto no estÃ¡ disponible por ahora." : "";

  showModal(modal);

  // hash para compartir producto
  const base = location.origin + location.pathname;
  history.replaceState(null,"", base + "#p=" + encodeURIComponent(p.id));
}

$("prodClose").addEventListener("click", (e)=>{
  e.preventDefault();
  hideModal($("prodModal"));
});

/* ===========================
   CART STORAGE
=========================== */
function loadCart(){
  try{
    const raw = localStorage.getItem(CART_KEY);
    CART = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(CART)) CART = [];
  }catch{ CART = []; }
}
function saveCart(){
  try{ localStorage.setItem(CART_KEY, JSON.stringify(CART)); }catch{}
}
function cartCount(){
  return CART.reduce((s,i)=>s+(Number(i.qty||0)),0);
}
function updateCartBadge(){
  $("cartCount").textContent = String(cartCount());
}

/* ===========================
   CART OPERATIONS
=========================== */
function addToCart(id, qty=1){
  const p = DB.productos.find(x=>x.id===id);
  if(!p) return;
  if(Number(p.stock||0)<=0) return;

  const found = CART.find(x=>x.id===id);
  if(found) found.qty = Math.max(1, Number(found.qty||1) + qty);
  else CART.push({id, qty: Math.max(1, qty)});
  saveCart();
  updateCartBadge();
}
function setQty(id, qty){
  const item = CART.find(x=>x.id===id);
  if(!item) return;
  item.qty = Math.max(1, Number(qty||1));
  saveCart();
  updateCartBadge();
}
function removeItem(id){
  CART = CART.filter(x=>x.id!==id);
  saveCart();
  updateCartBadge();
}

$("btnAddCart").addEventListener("click", ()=>{
  const p = STATE.openedProduct;
  if(!p) return;
  addToCart(p.id, 1);
  $("modalHint").textContent = "âœ… Agregado al carrito";
  setTimeout(()=>{ $("modalHint").textContent=""; }, 1200);
});

/* ===========================
   CART UI (Step 1,2,3)
=========================== */
let CART_STEP = 1;
let CART_SHIP_COST = 0;
let CART_SHIP_LABEL = "â€”";
let CART_PAY_LABEL = "â€”";

function cartSubtotal(){
  let s = 0;
  CART.forEach(it=>{
    const p = DB.productos.find(x=>x.id===it.id);
    if(p) s += (Number(p.precio||0) * Number(it.qty||0));
  });
  return s;
}

function buildCartList(){
  const list = $("cartList");
  list.innerHTML = "";

  if(!CART.length){
    $("cartEmpty").style.display="block";
    return;
  }
  $("cartEmpty").style.display="none";

  CART.forEach(it=>{
    const p = DB.productos.find(x=>x.id===it.id);
    if(!p) return;

    const row = document.createElement("div");
    row.className = "cartItem";

    row.innerHTML = `
      <img class="cartItemImg" src="${safeText(p.imagen||"")}" alt="">
      <div>
        <div class="cartItemName">${safeText(p.nombre||"Producto")}</div>
        <div class="cartItemMeta">${fmtLps(p.precio||0)} Â· ${safeText(p.categoria||"")}${p.subcategoria?(" Â· "+safeText(p.subcategoria)):""}</div>

        <div class="qtyRow">
          <div class="qtyCtrls">
            <button class="qtyBtn" aria-label="menos">âˆ’</button>
            <div class="qtyNum">${Number(it.qty||1)}</div>
            <button class="qtyBtn" aria-label="mas">+</button>
          </div>
          <button class="trashBtn" aria-label="eliminar">ðŸ—‘ Eliminar</button>
        </div>
      </div>
    `;

    const btnMinus = row.querySelectorAll(".qtyBtn")[0];
    const btnPlus  = row.querySelectorAll(".qtyBtn")[1];
    const numEl = row.querySelector(".qtyNum");
    const trash = row.querySelector(".trashBtn");

    btnMinus.addEventListener("click", ()=>{
      const q = Math.max(1, Number(it.qty||1)-1);
      it.qty = q;
      numEl.textContent = String(q);
      saveCart(); updateCartBadge(); updateTotals();
    });
    btnPlus.addEventListener("click", ()=>{
      const q = Number(it.qty||1)+1;
      it.qty = q;
      numEl.textContent = String(q);
      saveCart(); updateCartBadge(); updateTotals();
    });
    trash.addEventListener("click", ()=>{
      removeItem(it.id);
      buildCartList();
      updateTotals();
    });

    list.appendChild(row);
  });
}

function updateTotals(){
  const sub = cartSubtotal();
  $("cartSubtotal").textContent = fmtLps(sub);
  $("cartShip").textContent = fmtLps(CART_SHIP_COST);
  $("cartTotal").textContent = fmtLps(sub + CART_SHIP_COST);

  $("sumSubtotal").textContent = fmtLps(sub);
  $("sumShip").textContent = fmtLps(CART_SHIP_COST);
  $("sumTotal").textContent = fmtLps(sub + CART_SHIP_COST);
}

function showCartStep(n){
  CART_STEP = n;
  $("cartStep1").style.display = (n===1) ? "block" : "none";
  $("cartStep2").style.display = (n===2) ? "block" : "none";
  $("cartStep3").style.display = (n===3) ? "block" : "none";

  $("cartBack").style.visibility = (n===1) ? "hidden" : "visible";
  $("cartNext").textContent = (n===3) ? "Enviar por WhatsApp" : "Continuar";
}

function openCart(){
  buildCartList();
  CART_SHIP_COST = 0;
  CART_SHIP_LABEL = "â€”";
  CART_PAY_LABEL = "â€”";
  updateTotals();

  if(!CART.length){
    showCartStep(1);
  } else {
    showCartStep(1);
  }
  showModal($("cartModal"));
}

$("btnCart").addEventListener("click", ()=>{
  hideModal($("prodModal"));
  openCart();
});
$("cartClose").addEventListener("click",(e)=>{
  e.preventDefault();
  hideModal($("cartModal"));
});

/* ===========================
   SHIPPING + PAYMENT RULES
   (Editable later in Sheets via envios/ajustes)
=========================== */
function getDefaultEnvios(){
  // fallback si no existe envios en JSON
  return {
    localZones: [
      { id:"centrica", label:"Zona cÃ©ntrica", cost:30, examples:"Ej: Centro, Barrio Abajo, Barrio Arriba, La Sabana (referencia)." },
      { id:"alejada", label:"Zona alejada", cost:45, examples:"Ej: Los Geranios, Jardines, Villas del RÃ­o, sectores retirados." },
      { id:"municipios", label:"Otros municipios (cerca)", cost:90, examples:"Ej: Villa de San Antonio, Flores, Palmerola, El SifÃ³n, Ajuterique, LejamanÃ­, Yarumela, La Paz (municipio)." }
    ],
    couriers: [
      { id:"cargo", label:"Cargo Expreso", normal:110, cod:170 },
      { id:"forza", label:"Forza", normal:110, cod:170 },
      { id:"c807", label:"C807", normal:110, cod:170 }
    ],
    busRange: { min:80, max:150, note:"El costo puede variar segÃºn la empresa de transporte y tu zona exacta. Se confirma por WhatsApp." }
  };
}

// Departamentos base (puedes ajustar luego en Sheets si quieres)
const HN_DEPTS = [
 "AtlÃ¡ntida","Choluteca","ColÃ³n","Comayagua","CopÃ¡n","CortÃ©s","El ParaÃ­so","Francisco MorazÃ¡n","Gracias a Dios",
 "IntibucÃ¡","Islas de la BahÃ­a","La Paz","Lempira","Ocotepeque","Olancho","Santa BÃ¡rbara","Valle","Yoro"
];

// Municipios bÃ¡sicos (deja â€œEscribir por WhatsAppâ€ si no quieres llenar)
const DEPT_MUNIS = {
  "Comayagua":["Comayagua","Siguatepeque","Villa de San Antonio","Ajuterique","LejamanÃ­","La Libertad","MeÃ¡mbar","San JerÃ³nimo","San JosÃ© de Comayagua","San Luis","TaulabÃ©","Las Lajas","Humuya","La Trinidad","Ojos de Agua","El Rosario"],
  "La Paz":["La Paz","Marcala","San Antonio del Norte","Santa Ana","Yarula","San Pedro de Tutule"],
  "Francisco MorazÃ¡n":["Tegucigalpa","ComayagÃ¼ela","Valle de Ãngeles","Santa LucÃ­a","Tatumbla","El Porvenir","Ojojona"],
  "CortÃ©s":["San Pedro Sula","Puerto CortÃ©s","Choloma","Villanueva","La Lima","Omoa"],
  "Yoro":["Yoro","El Progreso","Olanchito","Santa Rita","MorazÃ¡n"],
  // resto fallback
};

function fillDeptSelect(){
  const d = $("deptSelect");
  d.innerHTML = "";
  HN_DEPTS.forEach(x=>{
    const o = document.createElement("option");
    o.value = x; o.textContent = x;
    d.appendChild(o);
  });
}
function fillMuniSelect(dept){
  const m = $("muniSelect");
  m.innerHTML = "";
  const list = DEPT_MUNIS[dept] || ["(EscrÃ­belo en WhatsApp)"];
  list.forEach(x=>{
    const o = document.createElement("option");
    o.value = x; o.textContent = x;
    m.appendChild(o);
  });
}

/* Banks/Pay config via ajustes */
function getPaymentConfig(){
  const a = ajustesMap();
  const banks = [];

  // soporta banco_1_nombre / banco_1_cuenta / banco_1_titular
  for(let i=1;i<=6;i++){
    const nombre = a[`banco_${i}_nombre`];
    const cuenta = a[`banco_${i}_cuenta`];
    const titular = a[`banco_${i}_titular`];
    if(nombre && cuenta){
      banks.push({ id:`b${i}`, nombre, cuenta, titular: titular||"" });
    }
  }

  const paypal = a["paypal_link"] || "";
  const tigo = a["tigo_numero"] || "";

  return { banks, paypal, tigo };
}

function fillBanks(selectId, infoId){
  const { banks } = getPaymentConfig();
  const sel = $(selectId);
  const info = $(infoId);

  sel.innerHTML = "";
  if(!banks.length){
    const o = document.createElement("option");
    o.value = "na"; o.textContent = "No configurado";
    sel.appendChild(o);
    info.textContent = "Configura bancos en Google Sheets (ajustes).";
    return;
  }

  banks.forEach(b=>{
    const o = document.createElement("option");
    o.value = b.id;
    o.textContent = b.nombre;
    sel.appendChild(o);
  });

  const showInfo = ()=>{
    const cur = banks.find(x=>x.id===sel.value) || banks[0];
    info.textContent = `${cur.nombre} Â· Cuenta: ${cur.cuenta}${cur.titular?(" Â· Titular: "+cur.titular):""}`;
  };
  sel.addEventListener("change", showInfo);
  showInfo();
}

function updatePaypalTigo(){
  const { paypal, tigo } = getPaymentConfig();
  const pInfo = `Enlace: ${paypal || "(no configurado)"}`;
  const tInfo = `NÃºmero: ${tigo || "(no configurado)"}`;

  $("paypalInfo").textContent = pInfo;
  $("paypalInfo2").textContent = pInfo;
  $("paypalInfo3").textContent = pInfo;

  $("tigoInfo").textContent = tInfo;
  $("tigoInfo2").textContent = tInfo;
  $("tigoInfo3").textContent = tInfo;
}

/* ===========================
   STEP2 UI LOGIC
=========================== */
function getEnvios(){
  const def = getDefaultEnvios();

  // si DB.envios viene con estructura, Ãºsala; si no, fallback
  // (no rompemos nada)
  return {
    localZones: Array.isArray(DB.envios?.localZones) ? DB.envios.localZones : def.localZones,
    couriers: Array.isArray(DB.envios?.couriers) ? DB.envios.couriers : def.couriers,
    busRange: DB.envios?.busRange ? DB.envios.busRange : def.busRange,
  };
}

function fillLocalZones(){
  const { localZones } = getEnvios();
  const sel = $("localZone");
  sel.innerHTML = "";
  localZones.forEach(z=>{
    const o = document.createElement("option");
    o.value = z.id;
    o.textContent = `${z.label} (${fmtLps(z.cost)})`;
    o.dataset.cost = String(z.cost||0);
    o.dataset.examples = z.examples || "";
    sel.appendChild(o);
  });

  const update = ()=>{
    const opt = sel.selectedOptions[0];
    const ex = opt?.dataset.examples || "";
    $("zoneExamples").textContent = ex ? ex : "";
  };
  sel.addEventListener("change", update);
  update();
}

function fillCouriers(){
  const { couriers } = getEnvios();
  const sel = $("courierSelect");
  sel.innerHTML = "";
  couriers.forEach(c=>{
    const o = document.createElement("option");
    o.value = c.id;
    o.textContent = c.label;
    o.dataset.normal = String(c.normal||0);
    o.dataset.cod = String(c.cod||0);
    sel.appendChild(o);
  });
}

function updateShipAndPayUI(){
  const loc = $("locType").value;

  $("comayaguaBlock").style.display = (loc==="comayagua") ? "block" : "none";
  $("fueraBlock").style.display = (loc==="fuera") ? "block" : "none";

  $("locHelp").textContent = (loc==="comayagua")
    ? "Entrega local segÃºn zona / municipio."
    : "EnvÃ­o por empresa o bus.";

  // Local payment blocks
  const payL = $("payLocal").value;
  $("cashBlock").style.display = (payL==="efectivo") ? "block" : "none";
  $("bankBlock").style.display = (payL==="transferencia") ? "block" : "none";
  $("paypalBlock").style.display = (payL==="paypal") ? "block" : "none";
  $("tigoBlock").style.display = (payL==="tigo") ? "block" : "none";

  // Fuera: empresa/bus toggle
  const shipType = $("shipType").value;
  $("empresaBlock").style.display = (shipType==="empresa") ? "block" : "none";
  $("busBlock").style.display = (shipType==="bus") ? "block" : "none";

  if(shipType==="empresa"){
    $("shipTypeHelp").textContent = "Selecciona empresa y servicio (normal o contra entrega).";
  } else {
    const { busRange } = getEnvios();
    $("shipTypeHelp").textContent = "Se confirmarÃ¡ el costo exacto por WhatsApp.";
    $("busInfo").textContent = `Rango estimado: ${fmtLps(busRange.min)} a ${fmtLps(busRange.max)}. ${busRange.note||""}`;
  }

  // Fuera payment blocks (empresa)
  const payF = $("payFuera").value;
  $("bankBlock2").style.display = (payF==="transferencia") ? "block" : "none";
  $("paypalBlock2").style.display = (payF==="paypal") ? "block" : "none";
  $("tigoBlock2").style.display = (payF==="tigo") ? "block" : "none";
  // si eligen COD, no mostramos bancos
  if(payF==="cod"){
    $("bankBlock2").style.display = "none";
    $("paypalBlock2").style.display = "none";
    $("tigoBlock2").style.display = "none";
  }

  // Bus payment blocks
  const payB = $("payBus").value;
  $("bankBlock3").style.display = (payB==="transferencia") ? "block" : "none";
  $("paypalBlock3").style.display = (payB==="paypal") ? "block" : "none";
  $("tigoBlock3").style.display = (payB==="tigo") ? "block" : "none";
}

function updateCambioEstimado(){
  const payL = $("payLocal").value;
  if(payL!=="efectivo"){
    $("cashChange").textContent = "";
    return;
  }
  const withVal = Number(String($("cashWith").value||"").replace(/[^\d]/g,"")||0);
  const total = cartSubtotal() + CART_SHIP_COST;
  if(withVal<=0){
    $("cashChange").textContent = "Ingresa el monto para calcular el cambio estimado.";
    return;
  }
  const change = withVal - total;
  $("cashChange").textContent = (change>=0)
    ? `Cambio estimado: ${fmtLps(change)}`
    : `Te faltan: ${fmtLps(Math.abs(change))}`;
}

function computeShippingCost(){
  const loc = $("locType").value;
  const env = getEnvios();

  if(loc==="comayagua"){
    const sel = $("localZone");
    const opt = sel.selectedOptions[0];
    const cost = Number(opt?.dataset.cost||0);
    CART_SHIP_COST = cost;
    CART_SHIP_LABEL = opt ? opt.textContent : "Entrega local";
    return;
  }

  // fuera
  const shipType = $("shipType").value;
  if(shipType==="bus"){
    // rango: usamos mÃ­nimo solo para total estimado
    CART_SHIP_COST = Number(env.busRange.min||0);
    CART_SHIP_LABEL = `Bus/Encomienda (rango ${fmtLps(env.busRange.min)}-${fmtLps(env.busRange.max)})`;
    return;
  }

  const courierOpt = $("courierSelect").selectedOptions[0];
  const service = $("courierService").value;
  const cost = Number(service==="cod" ? (courierOpt?.dataset.cod||0) : (courierOpt?.dataset.normal||0));
  CART_SHIP_COST = cost;
  CART_SHIP_LABEL = `Empresa: ${courierOpt?.textContent||""} Â· ${service==="cod"?"Contra entrega":"Normal"}`;
}

/* ===========================
   CHECKOUT FLOW
=========================== */
function validateStep2(){
  if(!CART.length) return "Tu carrito estÃ¡ vacÃ­o.";

  const name = $("custName").value.trim();
  const addr = $("custAddr").value.trim();
  if(name.length<3) return "Escribe tu nombre.";
  if(addr.length<6) return "Escribe tu direcciÃ³n / referencias.";

  const loc = $("locType").value;
  if(loc==="comayagua"){
    const pay = $("payLocal").value;
    if(pay==="efectivo"){
      const withVal = Number(String($("cashWith").value||"").replace(/[^\d]/g,"")||0);
      if(withVal<=0) return "Ingresa con cuÃ¡nto pagarÃ¡s (efectivo).";
    }
  } else {
    const shipType = $("shipType").value;
    if(shipType==="empresa"){
      const payF = $("payFuera").value;
      if(payF==="cod"){
        // ok
      }
    }
  }
  return "";
}

function buildWhatsAppMessage(){
  const a = ajustesMap();
  const wa = (a["whatsapp_numero"] || WA_NUMBER_DEFAULT).replace(/\D/g,"");

  const name = $("custName").value.trim();
  const phone = $("custPhone").value.trim();
  const addr = $("custAddr").value.trim();

  const loc = $("locType").value;

  // items
  const lines = [];
  lines.push(`ðŸ›’ *Pedido SDC*`);
  lines.push(`ðŸ‘¤ *Cliente:* ${name}${phone?(" Â· "+phone):""}`);
  lines.push(`ðŸ“ *DirecciÃ³n:* ${addr}`);
  lines.push("");

  lines.push("*Productos:*");
  CART.forEach(it=>{
    const p = DB.productos.find(x=>x.id===it.id);
    if(!p) return;
    const sub = Number(p.precio||0) * Number(it.qty||0);
    lines.push(`- ${it.qty} x ${p.nombre} (${fmtLps(p.precio)}) = ${fmtLps(sub)}`);
  });

  const subtotal = cartSubtotal();
  const total = subtotal + CART_SHIP_COST;

  lines.push("");
  lines.push(`ðŸ’° *Subtotal:* ${fmtLps(subtotal)}`);
  lines.push(`ðŸšš *EnvÃ­o/Entrega:* ${CART_SHIP_LABEL} Â· ${fmtLps(CART_SHIP_COST)}${(loc==="fuera" && $("shipType").value==="bus") ? " (estimado)" : ""}`);
  lines.push(`âœ… *Total:* ${fmtLps(total)}`);

  // payment
  lines.push("");
  if(loc==="comayagua"){
    const pay = $("payLocal").value;
    if(pay==="efectivo"){
      const withVal = Number(String($("cashWith").value||"").replace(/[^\d]/g,"")||0);
      const change = withVal - total;
      lines.push(`ðŸ’µ *Pago:* Efectivo (Pagar al recibir)`);
      lines.push(`   - Paga con: ${fmtLps(withVal)}`);
      lines.push(`   - Cambio estimado: ${change>=0 ? fmtLps(change) : "Faltan "+fmtLps(Math.abs(change))}`);
    } else if(pay==="transferencia"){
      lines.push(`ðŸ¦ *Pago:* Transferencia bancaria`);
      lines.push(`   - ${$("bankInfo").textContent}`);
    } else if(pay==="paypal"){
      lines.push(`ðŸ’³ *Pago:* PayPal`);
      lines.push(`   - ${$("paypalInfo").textContent}`);
    } else if(pay==="tigo"){
      lines.push(`ðŸ“² *Pago:* Tigo Money`);
      lines.push(`   - ${$("tigoInfo").textContent}`);
    }
  } else {
    const shipType = $("shipType").value;
    const dept = $("deptSelect").value;
    const muni = $("muniSelect").value;

    lines.push(`ðŸ™ï¸ *Destino:* ${dept} Â· ${muni}`);

    if(shipType==="empresa"){
      const payF = $("payFuera").value;
      const service = $("courierService").value;

      lines.push(`ðŸšš *EnvÃ­o:* ${CART_SHIP_LABEL}`);

      if(payF==="cod"){
        lines.push(`ðŸ’µ *Pago:* Contra entrega (pagar al recibir)`);
      } else if(payF==="transferencia"){
        lines.push(`ðŸ¦ *Pago:* Transferencia bancaria`);
        lines.push(`   - ${$("bankInfo2").textContent}`);
      } else if(payF==="paypal"){
        lines.push(`ðŸ’³ *Pago:* PayPal`);
        lines.push(`   - ${$("paypalInfo2").textContent}`);
      } else if(payF==="tigo"){
        lines.push(`ðŸ“² *Pago:* Tigo Money`);
        lines.push(`   - ${$("tigoInfo2").textContent}`);
      }

      if(service==="cod"){
        lines.push(`âš ï¸ Nota: Contra entrega puede variar segÃºn la empresa.`);
      }
    } else {
      // bus
      lines.push(`ðŸšŒ *EnvÃ­o:* ${CART_SHIP_LABEL}`);
      const payB = $("payBus").value;
      if(payB==="transferencia"){
        lines.push(`ðŸ¦ *Pago:* Transferencia bancaria`);
        lines.push(`   - ${$("bankInfo3").textContent}`);
      } else if(payB==="paypal"){
        lines.push(`ðŸ’³ *Pago:* PayPal`);
        lines.push(`   - ${$("paypalInfo3").textContent}`);
      } else if(payB==="tigo"){
        lines.push(`ðŸ“² *Pago:* Tigo Money`);
        lines.push(`   - ${$("tigoInfo3").textContent}`);
      }
      lines.push(`âš ï¸ Nota: El costo exacto de encomienda se confirma por WhatsApp.`);
    }
  }

  lines.push("");
  lines.push("ðŸ™ Gracias por tu compra.");

  const text = lines.join("\n");
  const url = `https://wa.me/${wa}?text=${encodeURIComponent(text)}`;
  return { url, text, subtotal, total };
}

/* ===========================
   CART BUTTONS
=========================== */
$("cartBack").addEventListener("click", ()=>{
  if(CART_STEP===1) return;
  showCartStep(CART_STEP-1);
});

$("cartNext").addEventListener("click", ()=>{
  if(CART_STEP===1){
    if(!CART.length){ alert("Tu carrito estÃ¡ vacÃ­o."); return; }
    // Paso 2: preparar selects
    fillLocalZones();
    fillCouriers();
    fillDeptSelect();
    fillMuniSelect($("deptSelect").value);

    fillBanks("bankSelect","bankInfo");
    fillBanks("bankSelect2","bankInfo2");
    fillBanks("bankSelect3","bankInfo3");
    updatePaypalTigo();

    computeShippingCost();
    updateTotals();
    updateShipAndPayUI();
    updateCambioEstimado();
    showCartStep(2);
    return;
  }

  if(CART_STEP===2){
    computeShippingCost();
    updateTotals();
    updateCambioEstimado();

    const err = validateStep2();
    if(err){ alert(err); return; }

    // resumen
    const { subtotal, total } = buildWhatsAppMessage();
    $("sumDetails").textContent =
      `Entrega/EnvÃ­o: ${CART_SHIP_LABEL}\nPago: ${CART_PAY_LABEL || "segÃºn selecciÃ³n"}\n\nCliente: ${$("custName").value.trim()}`;
    showCartStep(3);
    return;
  }

  if(CART_STEP===3){
    computeShippingCost();
    updateTotals();
    const err = validateStep2();
    if(err){ alert(err); return; }
    const { url } = buildWhatsAppMessage();
    window.open(url, "_blank", "noopener");
  }
});

// step2 listeners
$("locType").addEventListener("change", ()=>{
  updateShipAndPayUI();
  computeShippingCost();
  updateTotals();
  updateCambioEstimado();
});

$("localZone").addEventListener("change", ()=>{
  computeShippingCost();
  updateTotals();
  updateCambioEstimado();
});
$("payLocal").addEventListener("change", ()=>{
  updateShipAndPayUI();
  updateCambioEstimado();
});
$("cashWith").addEventListener("input", updateCambioEstimado);

$("deptSelect").addEventListener("change", ()=>{
  fillMuniSelect($("deptSelect").value);
});
$("shipType").addEventListener("change", ()=>{
  updateShipAndPayUI();
  computeShippingCost();
  updateTotals();
});
$("courierSelect").addEventListener("change", ()=>{
  computeShippingCost();
  updateTotals();
});
$("courierService").addEventListener("change", ()=>{
  computeShippingCost();
  updateTotals();
});
$("payFuera").addEventListener("change", ()=>{
  updateShipAndPayUI();
});
$("payBus").addEventListener("change", ()=>{
  updateShipAndPayUI();
});

/* ===========================
   SHARE BUTTONS (top)
=========================== */
$("btnShareCategory").addEventListener("click", async ()=>{
  const url = shareUrlFor(STATE.categoria, "Todas");
  try{ await copyToClipboard(url); alert("Enlace copiado"); }
  catch{ alert("No se pudo copiar"); }
});
$("btnShareSub").addEventListener("click", async ()=>{
  const url = shareUrlFor(STATE.categoria, STATE.subcategoria);
  try{ await copyToClipboard(url); alert("Enlace copiado"); }
  catch{ alert("No se pudo copiar"); }
});

/* ===========================
   HASH ROUTING
=========================== */
function applyStateFromHash(){
  const h = location.hash || "";
  if(!h || h==="#") return;

  const raw = h.replace(/^#/,"");
  const parts = raw.split("&").reduce((acc,kv)=>{
    const [k,v] = kv.split("=");
    if(k && v!=null) acc[k]=decodeURIComponent(v);
    return acc;
  },{});

  if(parts.p){
    const p = DB.productos.find(x=>x.id===parts.p);
    if(p) openProduct(p);
  }

  if(parts.cat){
    STATE.categoria = parts.cat;
  }
  if(parts.sub){
    STATE.subcategoria = parts.sub;
  }
}

function applyHashFromState(replace=false){
  const url = shareUrlFor(STATE.categoria, STATE.subcategoria);
  if(replace) history.replaceState(null,"",url);
  else location.hash = url.split("#")[1] || "";
}

window.addEventListener("hashchange", ()=>{
  applyStateFromHash();
  renderCategorias();
  renderSubcategorias();
  renderProductos();
  updateShareButtons();
});

/* ===========================
   UI WIRE
=========================== */
function wireUI(){
  // Theme
  const saved = localStorage.getItem("sdc_theme") || "dark";
  setTheme(saved);
  $("btnTheme").addEventListener("click", ()=>{
    const now = document.body.classList.contains("light") ? "light" : "dark";
    setTheme(now==="light" ? "dark" : "light");
  });

  // Search
  $("btnSearch").addEventListener("click", ()=>$("searchInput").focus());
  $("searchInput").addEventListener("input",(e)=>{
    STATE.query = e.target.value || "";
    renderProductos();
  });

  // Brand click to top
  $("brandHome").addEventListener("click", ()=>{
    window.scrollTo({top:0, behavior:"smooth"});
  });
  $("storeName").addEventListener("click", ()=>{
    window.scrollTo({top:0, behavior:"smooth"});
  });
}

/* ===========================
   INIT
=========================== */
async function init(){
  wireUI();
  loadCart();
  updateCartBadge();

  // loading skeleton
  $("loadingBlock").style.display = "block";
  $("grid").innerHTML = `
    <div class="skelGrid" style="width:100%">
      ${Array.from({length:8}).map(()=>`
        <div class="skelCard">
          <div class="skelImg"></div>
          <div class="skelBody">
            <div class="skelLine lg"></div>
            <div class="skelLine md"></div>
            <div class="skelLine sm"></div>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  try{
    const data = await apiGetAll();

    DB.productos = (data.productos || []).map(normalizeProduct).filter(p=>p.id && p.nombre);
    DB.categorias = data.categorias || [];
    DB.ajustes = data.ajustes || [];
    DB.envios = data.envios || data.envio || data.shipping || []; // flex

    applyAjustes();

    // first render
    renderCategorias();
    renderSubcategorias();
    updateShareButtons();

    // apply hash selection
    applyStateFromHash();

    // ensure subcategory exists for chosen cat
    if(STATE.categoria && STATE.categoria!=="Todas" && STATE.categoria!=="OFERTAS"){
      const subs = getSubcategorias(STATE.categoria);
      if(subs.length && STATE.subcategoria!=="Todas" && !subs.includes(STATE.subcategoria)){
        STATE.subcategoria="Todas";
      }
    } else {
      STATE.subcategoria="Todas";
    }

    renderCategorias();
    renderSubcategorias();
    renderProductos();
    updateShareButtons();

  } catch(err){
    console.error(err);
    $("sectionTitle").textContent = "Error cargando catÃ¡logo. Revisa API/Sheets.";
    $("grid").innerHTML = `<div style="color:var(--muted);padding:10px 2px;">${String(err.message||err)}</div>`;
  } finally {
    $("loadingBlock").style.display = "none";
  }
}

init();
</script>

</body>
</html>