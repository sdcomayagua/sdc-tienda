<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SDComayagua | Cat√°logo</title>

<style>
/* =========================
   VARIABLES / TEMA
========================= */
:root{
  --bg:#0b0f19;
  --card:#111a2e;
  --soft:#1b2a4d;
  --text:#e7eefc;
  --muted:#9fb2d6;
  --primary:#0b57ff;
  --border:rgba(255,255,255,.1);
}
body.light{
  --bg:#f4f6ff;
  --card:#ffffff;
  --soft:#eef2ff;
  --text:#0b1220;
  --muted:#5a6a87;
  --border:rgba(0,0,0,.1);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

/* =========================
   TOPBAR
========================= */
.topbar{
  position:sticky;
  top:0;
  z-index:50;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px;
  background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
  backdrop-filter:blur(10px);
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo{
  width:42px;
  height:42px;
  border-radius:14px;
  background:var(--primary);
  color:#fff;
  display:grid;
  place-items:center;
  font-weight:900;
}
.brandText{
  line-height:1.1;
}
.brandText b{font-size:16px}
.brandText small{
  color:var(--muted);
  font-size:12px;
}

.topActions{
  display:flex;
  gap:10px;
}
.iconBtn{
  width:42px;
  height:42px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:18px;
}
.cartBtn{
  position:relative;
}
.badge{
  position:absolute;
  top:-6px;
  right:-6px;
  background:var(--primary);
  color:#fff;
  font-size:12px;
  padding:2px 6px;
  border-radius:999px;
}

/* =========================
   SEARCH
========================= */
.searchWrap{padding:12px}
.search{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:14px;
}

/* =========================
   CHIPS
========================= */
.chips,.subchips{
  display:flex;
  gap:10px;
  overflow:auto;
  padding:8px 12px;
}
.chip{
  padding:10px 14px;
  border-radius:999px;
  background:var(--card);
  border:1px solid var(--border);
  color:var(--muted);
  font-weight:800;
  white-space:nowrap;
}
.chip.active{
  background:var(--primary);
  color:#fff;
  border-color:transparent;
}

/* =========================
   GRID
========================= */
.container{padding:12px}
.sectionTitle{
  font-weight:900;
  margin:10px 0;
}
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
@media(min-width:900px){
  .grid{grid-template-columns:repeat(4,1fr)}
}
.card{
  background:var(--card);
  border-radius:18px;
  overflow:hidden;
  border:1px solid var(--border);
  position:relative;
}
.card img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  background:#000;
}
.cardBody{padding:12px}
.cardTitle{font-weight:900;font-size:14px}
.cardDesc{font-size:12px;color:var(--muted);margin-top:4px}
.priceRow{display:flex;gap:8px;align-items:center;margin-top:8px}
.price{font-weight:900}
.old{text-decoration:line-through;color:var(--muted);font-size:12px}
.btn{
  margin-top:10px;
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  font-weight:900;
}
.btnPrimary{background:var(--primary);color:#fff}
.btnDisabled{background:#444;color:#999}

.card.agotado{opacity:.45}
.card.oferta::before{
  content:"OFERTA";
  position:absolute;
  top:10px;
  left:10px;
  background:#ff3b3b;
  color:#fff;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
}

/* =========================
   MODALS
========================= */
.backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:90;
}
.backdrop.show{display:block}

.modal{
  position:fixed;
  inset:auto 12px 12px 12px;
  background:var(--card);
  border-radius:22px;
  border:1px solid var(--border);
  z-index:100;
  display:none;
  max-height:88vh;
  overflow:hidden;
}
.modal.show{display:block}
.modalHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-bottom:1px solid var(--border);
}
.modalBody{
  padding:14px;
  overflow:auto;
}
.modalClose{
  border:none;
  background:transparent;
  color:var(--text);
  font-size:20px;
}

/* =========================
   CART
========================= */
.cartRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.qty{
  display:flex;
  align-items:center;
  gap:8px;
}
.qty button{
  width:28px;
  height:28px;
  border-radius:8px;
  border:none;
  background:var(--soft);
  color:var(--text);
  font-weight:900;
}

/* =========================
   FOOTER
========================= */
.footer{
  padding:12px;
  font-size:12px;
  color:var(--muted);
  text-align:center;
}

/* =========================
   LOADING
========================= */
.loading{
  padding:40px;
  text-align:center;
  color:var(--muted);
}
</style>
</head>

<body>

<!-- =========================
     TOPBAR
========================= -->
<div class="topbar">
  <div class="brand">
    <div class="logo">SDC</div>
    <div class="brandText">
      <b>SDComayagua</b>
      <small>Cat√°logo</small>
    </div>
  </div>

  <div class="topActions">
    <button class="iconBtn" id="btnSearch">üîç</button>
    <button class="iconBtn" id="btnTheme">üåô</button>
    <button class="iconBtn cartBtn" id="btnCart">
      üõí
      <span class="badge" id="cartCount">0</span>
    </button>
  </div>
</div>

<div class="searchWrap">
  <input class="search" placeholder="Buscar producto..." id="searchInput">
</div>

<div class="chips" id="chips"></div>
<div class="subchips" id="subchips"></div>

<div class="container">
  <div class="sectionTitle" id="sectionTitle">Productos</div>
  <div class="grid" id="grid"></div>
</div>

<div class="footer">¬© SDC</div>

<div class="backdrop" id="backdrop"></div>

<div class="modal" id="prodModal">
  <div class="modalHeader">
    <div>
      <b id="modalName"></b><br>
      <small id="modalSub"></small>
    </div>
    <button class="modalClose" id="prodClose">‚úï</button>
  </div>
  <div class="modalBody">
    <img id="modalMainImg" style="width:100%;border-radius:14px">
    <h3 id="modalPrice"></h3>
    <div id="modalOld" class="old"></div>
    <p id="modalDesc"></p>
    <button class="btn btnPrimary" id="btnAddCart">Agregar al carrito</button>
  </div>
</div>

<div class="modal" id="cartModal">
  <div class="modalHeader">
    <b>Carrito y pedido</b>
    <button class="modalClose" id="cartClose">‚úï</button>
  </div>
  <div class="modalBody">
    <div id="cartStep1">
      <div id="cartEmpty">Tu carrito est√° vac√≠o.</div>
      <div id="cartList"></div>
      <hr>
      <b>Subtotal:</b> <span id="cartSubtotal">Lps. 0</span><br>
      <b>Total:</b> <span id="cartTotal">Lps. 0</span>
      <button class="btn btnPrimary" id="cartNext">Continuar</button>
    </div>
  </div>
</div>

<div class="loading" id="loadingBlock">Cargando cat√°logo‚Ä¶</div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbytPfD9mq__VO7I2lnpBsqdCIT119ZT0zVyz0eeVjrJVgN_q8FYGgmqY6G66C2m67Pa4g/exec";
const CART_KEY = "sdc_cart_single_v2026";
const THEME_KEY = "sdc_theme_v1";

let DATA = null;
let PRODUCTS = [];
let BY_ID = {};
let STATE = { cat: null, sub: null, q: "" };
let CART = []; // [{id, qty}]

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
const money = (n)=>`Lps. ${Math.round(Number(n||0)).toLocaleString("es-HN")}`;

function safeStr(x){ return String(x||"").trim(); }
function isOffer(p){ return Number(p.precio_anterior||0) > Number(p.precio||0); }
function isOut(p){ return Number(p.stock||0) <= 0; }

function show(el){ el.style.display="block"; }
function hide(el){ el.style.display="none"; }

function openModal(modal){
  $("backdrop").classList.add("show");
  modal.classList.add("show");
}
function closeModal(modal){
  modal.classList.remove("show");
  // si no hay otros modales abiertos, quitamos backdrop
  const anyOpen = $("prodModal").classList.contains("show") || $("cartModal").classList.contains("show");
  if(!anyOpen) $("backdrop").classList.remove("show");
}

function saveCart(){
  localStorage.setItem(CART_KEY, JSON.stringify(CART));
  updateCartBadge();
}
function loadCart(){
  try{ CART = JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
  catch{ CART=[]; }
  if(!Array.isArray(CART)) CART=[];
  updateCartBadge();
}

function updateCartBadge(){
  const count = CART.reduce((a,it)=>a + Number(it.qty||0), 0);
  $("cartCount").textContent = String(count);
}

function cartSubtotal(){
  return CART.reduce((sum,it)=>{
    const p = BY_ID[it.id];
    if(!p) return sum;
    return sum + Number(p.precio||0) * Number(it.qty||0);
  },0);
}

function copyText(txt){
  navigator.clipboard.writeText(txt)
    .then(()=>alert("Enlace copiado ‚úÖ"))
    .catch(()=>alert("No se pudo copiar"));
}

/* =========================
   THEME
========================= */
function applyTheme(){
  const t = localStorage.getItem(THEME_KEY) || "dark";
  document.body.classList.toggle("light", t==="light");
  $("btnTheme").textContent = (t==="light") ? "‚òÄÔ∏è" : "üåô";
}
function toggleTheme(){
  const isLight = document.body.classList.contains("light");
  const next = isLight ? "dark" : "light";
  localStorage.setItem(THEME_KEY, next);
  applyTheme();
}

/* =========================
   HASH (cat/sub/p)
========================= */
function setHash(params){
  const base = location.origin + location.pathname;
  const parts = [];
  for(const k in params){
    if(params[k]) parts.push(`${k}=${encodeURIComponent(params[k])}`);
  }
  history.replaceState(null,"", base + (parts.length ? "#"+parts.join("&") : ""));
}

function readHash(){
  const h = (location.hash||"").replace("#","");
  const sp = new URLSearchParams(h);
  const cat = sp.get("cat");
  const sub = sp.get("sub");
  const p = sp.get("p");
  return { cat, sub, p };
}

/* =========================
   BUILD CHIPS
========================= */
function getCategoryList(){
  // Categor√≠as desde productos, sin "Todas" como chip (tal como pediste)
  const set = new Set(PRODUCTS.map(p=>p.categoria).filter(Boolean));
  const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));

  // OFERTAS al inicio si hay ofertas
  const hasOffers = PRODUCTS.some(isOffer);
  const out = [];
  out.push("VER TODO");
  if(hasOffers) out.push("OFERTAS");
  cats.forEach(c=>{ if(c && c!=="OFERTAS") out.push(c); });
  return out;
}

function getSubcategoryList(cat){
  if(!cat || cat==="VER TODO" || cat==="OFERTAS") return [];
  const set = new Set(PRODUCTS.filter(p=>p.categoria===cat).map(p=>p.subcategoria).filter(Boolean));
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

let lastCatTap={v:null,t:0};
let lastSubTap={v:null,t:0};

function renderCategories(){
  const wrap = $("chips");
  wrap.innerHTML = "";

  const cats = getCategoryList();

  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "chip" + ((STATE.cat===c || (!STATE.cat && c==="VER TODO")) ? " active":"");
    b.textContent = c;

    b.onclick = ()=>{
      const now=Date.now();
      // doble toque copiar enlace
      if(lastCatTap.v===c && (now-lastCatTap.t)<650){
        if(c==="VER TODO"){
          copyText(location.origin+location.pathname);
        }else{
          copyText(location.origin+location.pathname+"#cat="+encodeURIComponent(c));
        }
        lastCatTap={v:null,t:0};
        return;
      }
      lastCatTap={v:c,t:now};

      if(c==="VER TODO"){
        STATE.cat=null;
        STATE.sub=null;
        setHash({});
      }else{
        STATE.cat=c;
        STATE.sub=null;
        setHash({cat:c});
      }
      renderSubcategories();
      renderProducts();
    };

    wrap.appendChild(b);
  });
}

function renderSubcategories(){
  const wrap = $("subchips");
  wrap.innerHTML = "";

  const subs = getSubcategoryList(STATE.cat);
  if(!subs.length){
    wrap.style.display="none";
    return;
  }

  wrap.style.display="flex";

  // "Todas" solo aqu√≠
  const all = document.createElement("button");
  all.className = "chip" + (!STATE.sub ? " active":"");
  all.textContent = "Todas";
  all.onclick = ()=>{
    const now=Date.now();
    if(lastSubTap.v==="Todas" && (now-lastSubTap.t)<650){
      copyText(location.origin+location.pathname+"#cat="+encodeURIComponent(STATE.cat));
      lastSubTap={v:null,t:0};
      return;
    }
    lastSubTap={v:"Todas",t:now};

    STATE.sub=null;
    setHash({cat:STATE.cat});
    renderSubcategories();
    renderProducts();
  };
  wrap.appendChild(all);

  subs.forEach(sc=>{
    const b = document.createElement("button");
    b.className = "chip" + (STATE.sub===sc ? " active":"");
    b.textContent = sc;

    b.onclick = ()=>{
      const now=Date.now();
      if(lastSubTap.v===sc && (now-lastSubTap.t)<650){
        copyText(location.origin+location.pathname+"#cat="+encodeURIComponent(STATE.cat)+"&sub="+encodeURIComponent(sc));
        lastSubTap={v:null,t:0};
        return;
      }
      lastSubTap={v:sc,t:now};

      STATE.sub=sc;
      setHash({cat:STATE.cat, sub:sc});
      renderSubcategories();
      renderProducts();
    };

    wrap.appendChild(b);
  });
}

/* =========================
   RENDER PRODUCTS (OFERTAS + ORDEN)
========================= */
function filteredProducts(){
  let list = PRODUCTS.slice();

  // categor√≠a
  if(STATE.cat){
    if(STATE.cat==="OFERTAS"){
      list = list.filter(isOffer);
    }else{
      list = list.filter(p=>p.categoria===STATE.cat);
    }
  }

  // subcategor√≠a
  if(STATE.sub){
    list = list.filter(p=>p.subcategoria===STATE.sub);
  }

  // search
  const q = (STATE.q||"").toLowerCase().trim();
  if(q){
    list = list.filter(p=>
      (p.nombre||"").toLowerCase().includes(q) ||
      (p.descripcion||"").toLowerCase().includes(q) ||
      (p.subcategoria||"").toLowerCase().includes(q)
    );
  }

  // sort:
  // 1) disponibles primero
  // 2) orden num√©rico
  // 3) nombre
  list.sort((a,b)=>{
    const av = a.stock>0 ? 0 : 1;
    const bv = b.stock>0 ? 0 : 1;
    if(av!==bv) return av-bv;

    const ao = Number(a.orden||999999);
    const bo = Number(b.orden||999999);
    if(ao!==bo) return ao-bo;

    return (a.nombre||"").localeCompare(b.nombre||"");
  });

  return list;
}

function renderProducts(){
  const grid = $("grid");
  grid.innerHTML = "";

  const list = filteredProducts();

  let title = "Productos";
  if(STATE.cat==="OFERTAS") title = "OFERTAS";
  else if(STATE.cat && STATE.cat!=="VER TODO") title = STATE.cat;

  if(STATE.sub) title += " ¬∑ " + STATE.sub;

  $("sectionTitle").textContent = `${title} (${list.length})`;

  if(!list.length){
    grid.innerHTML = `<div style="grid-column:1/-1;color:var(--muted);padding:12px">No hay productos en esta secci√≥n.</div>`;
    return;
  }

  list.forEach(p=>{
    const card=document.createElement("div");
    card.className="card"+(isOut(p)?" agotado":"")+(isOffer(p)?" oferta":"");

    card.innerHTML=`
      <img src="${p.imagen||""}" alt="">
      <div class="cardBody">
        <div class="cardTitle">${p.nombre}</div>
        <div class="cardDesc">${p.descripcion||""}</div>
        <div class="priceRow">
          <div class="price">${money(p.precio)}</div>
          ${isOffer(p)?`<div class="old">${money(p.precio_anterior)}</div>`:""}
        </div>
        ${p.stock>0
          ?`<button class="btn btnPrimary">Ver detalles</button>`
          :`<button class="btn btnDisabled" disabled>Agotado</button>`}
      </div>
    `;

    if(p.stock>0){
      card.querySelector("button").onclick=()=>openProduct(p.id);
    }

    grid.appendChild(card);
  });
}

/* =========================
   PRODUCT MODAL
========================= */
function openProduct(id){
  const p = BY_ID[id];
  if(!p) return;

  $("modalName").textContent = p.nombre;
  $("modalSub").textContent = `${p.categoria}${p.subcategoria?(" ¬∑ "+p.subcategoria):""}`;
  $("modalMainImg").src = p.imagen || "";
  $("modalPrice").textContent = money(p.precio);
  $("modalOld").textContent = isOffer(p) ? money(p.precio_anterior) : "";
  $("modalDesc").textContent = p.descripcion || "";

  $("btnAddCart").onclick = ()=>{
    addCartItem(p.id, 1);
    closeModal($("prodModal"));
    openCart();
  };

  // hash producto (para compartir)
  setHash({p: p.id});

  openModal($("prodModal"));
}

/* =========================
   CART
========================= */
function addCartItem(id, qty){
  const p = BY_ID[id];
  if(!p) return;
  if(p.stock<=0) return;

  let it = CART.find(x=>x.id===id);
  if(!it){
    CART.push({id, qty: 1});
  }else{
    // respeta stock
    const next = it.qty + qty;
    if(next > p.stock){
      alert("Stock disponible: "+p.stock);
      return;
    }
    it.qty = next;
  }
  saveCart();
}

function openCart(){
  renderCart();
  openModal($("cartModal"));
}

function renderCart(){
  const list = $("cartList");
  list.innerHTML = "";

  if(CART.length===0){
    $("cartEmpty").style.display="block";
    $("cartSubtotal").textContent = money(0);
    $("cartTotal").textContent = money(0);
    return;
  }
  $("cartEmpty").style.display="none";

  let subtotal=0;

  CART.forEach((it,idx)=>{
    const p = BY_ID[it.id];
    if(!p) return;

    subtotal += p.precio * it.qty;

    const row=document.createElement("div");
    row.className="cartRow";
    row.innerHTML=`
      <div>
        <div><b>${p.nombre}</b></div>
        <small style="color:var(--muted)">${money(p.precio)} ¬∑ Cant: ${it.qty}</small>
      </div>
      <div class="qty">
        <button>-</button>
        <span>${it.qty}</span>
        <button>+</button>
      </div>
    `;

    const btnMinus = row.querySelectorAll("button")[0];
    const btnPlus  = row.querySelectorAll("button")[1];

    btnMinus.onclick = ()=>{
      it.qty = Math.max(1, it.qty-1);
      saveCart();
      renderCart();
    };
    btnPlus.onclick = ()=>{
      if(it.qty+1 > p.stock){
        alert("Stock disponible: "+p.stock);
        return;
      }
      it.qty++;
      saveCart();
      renderCart();
    };

    list.appendChild(row);
  });

  $("cartSubtotal").textContent = money(subtotal);
  $("cartTotal").textContent = money(subtotal);
}

/* =========================
   EVENTS
========================= */
$("btnSearch").onclick = ()=>$("searchInput").focus();
$("btnCart").onclick = openCart;

$("prodClose").onclick = ()=>{ closeModal($("prodModal")); setHash({cat:STATE.cat, sub:STATE.sub}); };
$("cartClose").onclick = ()=>closeModal($("cartModal"));

$("searchInput").addEventListener("input",(e)=>{
  STATE.q = e.target.value||"";
  renderProducts();
});

$("btnTheme").onclick = toggleTheme;

$("brandHome")?.addEventListener("click", ()=>{
  window.scrollTo({top:0, behavior:"smooth"});
});

/* =========================
   INIT
========================= */
async function init(){
  applyTheme();
  loadCart();

  // loading
  $("loadingBlock").style.display="block";
  $("grid").innerHTML = `
    <div class="skelGrid" style="width:100%">
      ${Array.from({length:8}).map(()=>`
        <div class="skelCard">
          <div class="skelImg"></div>
          <div class="skelBody">
            <div class="skelLine lg"></div>
            <div class="skelLine md"></div>
            <div class="skelLine sm"></div>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  try{
    const data = await (await fetch(API_URL,{cache:"no-store"})).json();
    DATA = data;

    PRODUCTS = (data.productos||[]).map(p=>({
      id: safeStr(p.id),
      nombre: safeStr(p.nombre),
      precio: Number(p.precio||0),
      precio_anterior: Number(p.precio_anterior||0),
      stock: Number(p.stock||0),
      categoria: safeStr(p.categoria||"General")||"General",
      subcategoria: safeStr(p.subcategoria||""),
      descripcion: safeStr(p.descripcion||""),
      imagen: safeStr(p.imagen||""),
      orden: Number(p.orden||999999)
    })).filter(p=>p.id && p.nombre);

    BY_ID = {};
    PRODUCTS.forEach(p=>BY_ID[p.id]=p);

    // hash
    const {cat, sub, p} = readHash();
    if(p && BY_ID[p]){
      // abrir directo
      STATE.cat = cat || null;
      STATE.sub = sub || null;
      renderCategories();
      renderSubcategories();
      renderProducts();
      openProduct(p);
    }else{
      STATE.cat = cat || null;
      STATE.sub = sub || null;
      renderCategories();
      renderSubcategories();
      renderProducts();
    }

  }catch(err){
    console.error(err);
    $("grid").innerHTML = `<div style="grid-column:1/-1;color:var(--muted);padding:12px">Error: ${err}</div>`;
  }finally{
    $("loadingBlock").style.display="none";
  }
}

init();
</script>

</body>
</html>