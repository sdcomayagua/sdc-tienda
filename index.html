<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>SDComayagua | CatÃ¡logo</title>

<style>
:root{
  --bg:#0b0f19; --card:#111a2e; --card2:#0f172a;
  --text:#e7eefc; --muted:#9fb2d6;
  --primary:#0b57ff; --danger:#ff2f2f;
  --soft:#1b2a4d; --border:rgba(255,255,255,.14);
  --shadow:0 12px 28px rgba(0,0,0,.35); --radius:18px;
}
body.light{
  --bg:#f6f8ff; --card:#ffffff; --card2:#ffffff;
  --text:#0b1220; --muted:#5a6a87;
  --soft:#e9efff; --border:rgba(0,0,0,.12);
  --shadow:0 12px 24px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}

.topbar{
  position:sticky; top:0; z-index:50;
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px;
  background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  backdrop-filter: blur(10px);
}
body.light .topbar{background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,0));}

.brand{display:flex; gap:10px; align-items:center; min-width:0; cursor:pointer;}
.logo{
  width:42px; height:42px; border-radius:14px;
  display:grid; place-items:center;
  background:var(--primary); color:#fff; font-weight:1000;
}
.brandText{min-width:0; display:flex; flex-direction:column; line-height:1.05}
#storeName{font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:58vw; text-decoration:none; color:inherit}
#storeSub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:58vw}
@media(min-width:860px){ #storeName,#storeSub{max-width:520px} }
@media(max-width:720px){
  #storeName{color:transparent; position:relative; font-size:16px}
  #storeName::after{content:"SDComayagua"; color:var(--text); position:absolute; left:0; top:0}
  #storeSub{font-size:11px; opacity:.9}
}

.topActions{display:flex; gap:10px; align-items:center;}
.iconBtn{
  width:42px; height:42px; border-radius:14px;
  border:1px solid var(--border);
  background:var(--card); color:var(--text);
  box-shadow:var(--shadow); font-size:16px;
}
.cartBtn{
  position:relative; height:42px; padding:0 14px;
  border-radius:14px; border:1px solid var(--border);
  background:var(--card); color:var(--text);
  box-shadow:var(--shadow); font-weight:1000;
}
.badge{
  display:inline-grid; place-items:center;
  min-width:22px; height:22px; padding:0 6px;
  border-radius:999px; background:var(--primary);
  color:#fff; font-size:12px; margin-left:6px;
}

.searchWrap{padding:8px 12px 12px;}
.search{
  width:100%; padding:14px;
  border-radius:16px; border:1px solid var(--border);
  background:var(--card); color:var(--text);
  outline:none; box-shadow:var(--shadow);
}

.chips,.subchips{
  display:flex; gap:10px; overflow:auto;
  padding:10px 12px 12px; scrollbar-width:none;
}
.chips::-webkit-scrollbar,.subchips::-webkit-scrollbar{display:none}
.chip{
  padding:10px 14px; border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text); font-weight:1000; font-size:13px;
  white-space:nowrap; cursor:pointer;
}
.chip.active{background:var(--primary); border-color:transparent; color:#fff}
body:not(.light) .chip{
  color: rgba(231,238,252,.92);
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.18);
}
.subchips{margin-top:-10px; padding-top:0; padding-bottom:10px; display:none}
.subchips .chip{padding:8px 12px; font-size:12px; background:rgba(255,255,255,.04)}
body.light .subchips .chip{background:rgba(0,0,0,.04)}

.sectionHeader{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:0 12px;}
.sectionTitle{font-weight:1000; font-size:16px}
.btnRow{display:flex; gap:10px; flex-wrap:wrap}
.btn{
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  padding:12px 14px;
  border-radius:16px;
  font-weight:1000;
}
.btnMini{padding:9px 10px; border-radius:12px; font-size:12px;}
.btnPrimary{background:var(--primary); border-color:transparent; color:#fff;}
.btnSoft{background:var(--soft)}
.btnFull{width:100%}

.gridWrap{padding:10px 12px 18px}
.grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;}
@media(min-width:840px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }

.card{
  border:1px solid var(--border);
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  position:relative;
}
.cardImg{width:100%; aspect-ratio:1/1; object-fit:cover; display:block; background:var(--card2);}
.cardBody{padding:12px}
.cardName{font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.cardDesc{color:var(--muted); font-size:12px; margin-top:6px; min-height:30px}
.priceRow{display:flex; gap:8px; align-items:baseline; margin-top:10px}
.price{font-weight:1000}
.price.offer{color:var(--danger)}
.old{color:var(--muted); text-decoration:line-through; font-size:12px}
.offerTag{
  position:absolute; top:10px; left:10px;
  padding:6px 10px; border-radius:999px;
  font-weight:1000; font-size:12px;
  background:rgba(255,47,47,.14);
  border:1px solid rgba(255,47,47,.35);
  color:var(--danger);
}
.card.out{filter:grayscale(1); opacity:.82}
.watermark{
  position:absolute; inset:0; display:grid; place-items:center;
  pointer-events:none; font-weight:1000; letter-spacing:2px;
  transform:rotate(-18deg); color:rgba(255,0,0,.35);
  font-size:clamp(18px,7vw,44px); text-transform:uppercase;
}

/* modal base */
.modalBackdrop{position:fixed; inset:0; z-index:80; background:rgba(0,0,0,.58); display:none;}
.modal{
  position:fixed; inset:auto 12px 12px 12px; z-index:90;
  max-width:860px; margin:0 auto;
  border:1px solid var(--border); background:var(--card);
  border-radius:22px; box-shadow:var(--shadow);
  display:none; max-height:88vh; overflow:hidden;
}
.modalHeader{display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid var(--border);}
.modalTitle{font-weight:1000; font-size:18px}
.modalSub{color:var(--muted); font-size:12px; margin-top:3px}
.closeBtn{width:42px;height:42px;border-radius:14px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:18px}
.modalBody{padding:14px; overflow:auto; max-height:calc(88vh - 140px)}
.modalFooter{padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap}
.modalFooter .btn{flex:1}

/* prod modal */
.prodMainImg{width:100%; border-radius:16px; border:1px solid var(--border); background:var(--card2); aspect-ratio:1/1; object-fit:cover}
.thumbs{display:flex; gap:10px; overflow:auto; padding:10px 0 6px; scrollbar-width:none}
.thumbs::-webkit-scrollbar{display:none}
.thumb{width:64px;height:64px;border-radius:14px;border:1px solid var(--border);object-fit:cover;opacity:.85}
.thumb.active{opacity:1; outline:2px solid rgba(11,87,255,.35)}
.prodMeta{color:var(--muted); line-height:1.35; font-size:13px; white-space:pre-wrap; margin-top:10px}
.videoBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.vbtn{padding:10px 12px; border-radius:16px; border:1px solid var(--border); background:var(--soft); color:var(--text); font-weight:1000; text-decoration:none}
.tabs{display:flex; gap:10px; margin-bottom:12px}
.tab{flex:1; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--text); font-weight:1000}
body.light .tab{background:rgba(0,0,0,.04)}
.tab.active{background:rgba(11,87,255,.18); border-color:rgba(11,87,255,.45)}
</style>
</head>

<body>
<header class="topbar">
  <div class="brand" id="brandHome">
    <div class="logo" id="logoText">SDC</div>
    <div class="brandText">
      <a id="storeName" href="javascript:void(0)">Soluciones Digitales Comayagua</a>
      <div id="storeSub">CatÃ¡logo</div>
    </div>
  </div>

  <div class="topActions">
    <button class="iconBtn" id="btnSearch">ðŸ”Ž</button>
    <button class="iconBtn" id="btnTheme">ðŸŒ™</button>
    <button class="cartBtn" id="btnCart">ðŸ›’ <span class="badge" id="cartCount">0</span></button>
  </div>
</header>

<nav class="chips" id="chips"></nav>
<nav class="subchips" id="subchips"></nav>

<div class="searchWrap">
  <input class="search" id="searchInput" placeholder="Buscar producto..." />
</div>

<div class="sectionHeader">
  <div class="sectionTitle" id="sectionTitle">Productos</div>
  <div class="btnRow">
    <button class="btn btnMini" id="btnViewAll" style="display:none">Ver todo</button>
    <button class="btn btnMini" id="btnShareCategory" style="display:none">Compartir categorÃ­a</button>
    <button class="btn btnMini" id="btnShareSub" style="display:none">Compartir sub</button>
  </div>
</div>

<div class="gridWrap"><div class="grid" id="grid"></div></div>

<div class="modalBackdrop" id="backdrop"></div>

<!-- Producto -->
<div class="modal" id="prodModal" aria-hidden="true">
  <div class="modalHeader">
    <div>
      <div class="modalTitle" id="modalName">Producto</div>
      <div class="modalSub" id="modalSub">â€”</div>
    </div>
    <button class="closeBtn" id="prodClose">âœ•</button>
  </div>
  <div class="modalBody">
    <img class="prodMainImg" id="modalMainImg" src="" alt="">
    <div class="thumbs" id="modalThumbs" style="display:none"></div>

    <div class="priceRow">
      <div class="price" id="modalPrice">Lps. 0</div>
      <div class="old" id="modalOld"></div>
    </div>

    <div class="prodMeta" id="modalDesc"></div>
    <div class="videoBtns" id="modalVideos" style="display:none"></div>
    <div class="hint" id="modalHint"></div>

    <div class="modalFooter" style="border-top:none; padding:0; margin-top:12px">
      <button class="btn btnPrimary" id="btnAddCart">Agregar al carrito</button>
      <button class="btn btnSoft" id="btnKeepBuying">Seguir comprando</button>
      <button class="btn btnSoft" id="btnGoPay">Ir a pagar</button>
    </div>
  </div>
</div>

<!-- Carrito -->
<div class="modal" id="cartModal" aria-hidden="true">
  <div class="modalHeader">
    <div>
      <div class="modalTitle">Carrito y pedido</div>
      <div class="modalSub">1-2-3</div>
    </div>
    <button class="closeBtn" id="cartClose">âœ•</button>
  </div>
  <div class="modalBody">
    <div class="tabs">
      <button class="tab active" id="tab1">Carrito</button>
      <button class="tab" id="tab2">Entrega</button>
      <button class="tab" id="tab3">Pago</button>
    </div>

    <div id="step1">
      <div id="cartEmpty" class="cartEmpty" style="display:none">Tu carrito estÃ¡ vacÃ­o.</div>
      <div class="cartList" id="cartList"></div>
      <div class="totals">
        <div class="row"><span>Subtotal</span><span id="cartSubtotal">Lps. 0</span></div>
        <div class="row"><span>EnvÃ­o</span><span id="cartShip">Lps. 0</span></div>
        <div class="row total"><span>Total</span><span id="cartTotal">Lps. 0</span></div>
      </div>
    </div>

    <div id="step2" style="display:none">
      <div class="hint">âœ… Paso Entrega: lo ajustamos con tu audio (reglas exactas).</div>
      <input class="search" id="dummyEntrega" placeholder="DirecciÃ³n / referencia">
    </div>

    <div id="step3" style="display:none">
      <div class="hint">âœ… Paso Pago: lo ajustamos con tu audio.</div>
      <button class="btn btnPrimary btnFull" id="btnSendWA">Enviar por WhatsApp</button>
    </div>
  </div>

  <div class="modalFooter">
    <button class="btn btnSoft" id="cartBack">AtrÃ¡s</button>
    <button class="btn btnPrimary" id="cartNext">Continuar</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbytPfD9mq__VO7I2lnpBsqdCIT119ZT0zVyz0eeVjrJVgN_q8FYGgmqY6G66C2m67Pa4g/exec";
const THEME_KEY="sdc_theme_v2";
const CART_KEY="sdc_cart_main_v2";
const WA_DEFAULT="50431517755";

let DB={productos:[], categorias:[], ajustes:[]};
let STATE={categoria:null, subcategoria:null, query:""};
let CART=[];
let CURRENT_PRODUCT=null;

const $=id=>document.getElementById(id);
const money=n=>`Lps. ${Math.round(Number(n||0)).toLocaleString("es-HN")}`;
const isOffer=p=>Number(p.precio_anterior||0)>Number(p.precio||0);
const isOut=p=>Number(p.stock||0)<=0;

function setTheme(next){
  document.body.classList.toggle("light", next==="light");
  localStorage.setItem(THEME_KEY,next);
  $("btnTheme").textContent = next==="light" ? "â˜€ï¸":"ðŸŒ™";
}
(function(){ setTheme(localStorage.getItem(THEME_KEY)||"dark"); })();

$("btnTheme").onclick=()=>{
  const now=document.body.classList.contains("light")?"light":"dark";
  setTheme(now==="light"?"dark":"light");
};
$("brandHome").onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
$("storeName").onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
$("btnSearch").onclick=()=>$("searchInput").focus();

function loadCart(){
  try{ CART=JSON.parse(localStorage.getItem(CART_KEY)||"[]"); }catch{ CART=[]; }
  if(!Array.isArray(CART)) CART=[];
  updateBadge();
}
function saveCart(){
  localStorage.setItem(CART_KEY,JSON.stringify(CART));
  updateBadge();
}
function updateBadge(){
  $("cartCount").textContent = String(CART.reduce((a,it)=>a+Number(it.qty||0),0));
}
function cartSubtotal(){
  return CART.reduce((sum,it)=>{
    const p=DB.productos.find(x=>x.id===it.id);
    return p? sum + Number(p.precio||0)*Number(it.qty||0) : sum;
  },0);
}

function showBackdrop(){ $("backdrop").style.display="block"; }
function hideBackdrop(){ $("backdrop").style.display="none"; }
function openModal(el){ showBackdrop(); el.style.display="block"; el.setAttribute("aria-hidden","false"); }
function closeModal(el){
  el.style.display="none"; el.setAttribute("aria-hidden","true");
  if($("prodModal").style.display!=="block" && $("cartModal").style.display!=="block") hideBackdrop();
}
$("backdrop").onclick=()=>{
  if($("prodModal").style.display==="block") closeModal($("prodModal"));
  if($("cartModal").style.display==="block") closeModal($("cartModal"));
};
$("prodClose").onclick=()=>closeModal($("prodModal"));
$("cartClose").onclick=()=>closeModal($("cartModal"));

$("searchInput").addEventListener("input",(e)=>{
  STATE.query=e.target.value||"";
  renderProducts();
});

async function loadAPI(){
  const res=await fetch(API_URL,{cache:"no-store"});
  const data=await res.json();

  DB.productos=(data.productos||[]).map(p=>({
    id:String(p.id||"").trim(),
    nombre:String(p.nombre||"").trim(),
    precio:Number(p.precio||0),
    precio_anterior:Number(p.precio_anterior||0),
    stock:Number(p.stock||0),
    categoria:String(p.categoria||"General").trim()||"General",
    subcategoria:String(p.subcategoria||"").trim(),
    imagen:String(p.imagen||"").trim(),
    descripcion:String(p.descripcion||"").trim(),
    orden:Number(p.orden||999999),
    video:String(p.video||p.video_url||"").trim(),
    galeria_1:String(p.galeria_1||"").trim(),
    galeria_2:String(p.galeria_2||"").trim(),
    galeria_3:String(p.galeria_3||"").trim(),
    galeria_4:String(p.galeria_4||"").trim(),
    galeria_5:String(p.galeria_5||"").trim(),
    galeria_6:String(p.galeria_6||"").trim(),
    galeria_7:String(p.galeria_7||"").trim(),
    galeria_8:String(p.galeria_8||"").trim(),
  })).filter(p=>p.id && p.nombre);

  DB.categorias=(data.categorias||[]).map(c=>({
    categoria:String(c.categoria||"").trim(),
    orden:Number(c.orden||999999),
    visible:String(c.visible??1)==="1" || c.visible===1 || c.visible===true
  })).filter(c=>c.categoria);

  DB.ajustes=data.ajustes||[];

  const a=ajustesMap();
  $("storeName").textContent=a.nombre_tienda||"Soluciones Digitales Comayagua";
  $("storeSub").textContent=a.subtitulo||"CatÃ¡logo";
  $("logoText").textContent=a.siglas||"SDC";
  const wa=(a.whatsapp_numero||WA_DEFAULT).replace(/\D/g,"");
  $("waFloat").href=`https://wa.me/${wa}?text=${encodeURIComponent(a.mensaje_whatsapp||"Hola, quiero consultar el catÃ¡logo.")}`;

  renderCategories();
  renderSubcategories();
  renderProducts();
}

function ajustesMap(){
  const map={};
  (DB.ajustes||[]).forEach(r=>{
    const k=String(r.clave||"").trim();
    const v=String(r.valor||"").trim();
    if(k) map[k]=v;
  });
  return map;
}

function getCategories(){
  let cats=[];
  if(DB.categorias.length){
    cats=DB.categorias.filter(c=>c.visible).sort((a,b)=>a.orden-b.orden).map(c=>c.categoria);
  }else{
    cats=[...new Set(DB.productos.map(p=>p.categoria))].sort((a,b)=>a.localeCompare(b));
  }
  const hasOffers=DB.productos.some(isOffer);
  const out=["VER TODO"];
  if(hasOffers) out.push("OFERTAS");
  cats.forEach(c=>{ if(c!=="OFERTAS") out.push(c); });
  return out;
}

function getSubcats(cat){
  if(!cat || cat==="VER TODO" || cat==="OFERTAS") return [];
  return [...new Set(DB.productos.filter(p=>p.categoria===cat).map(p=>p.subcategoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
}

function renderCategories(){
  const wrap=$("chips");
  wrap.innerHTML="";
  getCategories().forEach(c=>{
    const b=document.createElement("button");
    const active = (!STATE.categoria && c==="VER TODO") || (STATE.categoria===c);
    b.className="chip"+(active?" active":"");
    b.textContent=c;
    b.onclick=()=>{
      if(c==="VER TODO"){ STATE.categoria=null; STATE.subcategoria=null; }
      else { STATE.categoria=c; STATE.subcategoria=null; }
      renderCategories(); renderSubcategories(); renderProducts();
      updateShareButtons();
    };
    wrap.appendChild(b);
  });
  updateShareButtons();
}

function renderSubcategories(){
  const wrap=$("subchips");
  wrap.innerHTML="";
  const subs=getSubcats(STATE.categoria);
  if(!subs.length){ wrap.style.display="none"; return; }
  wrap.style.display="flex";

  const all=document.createElement("button");
  all.className="chip"+(!STATE.subcategoria?" active":"");
  all.textContent="Todas";
  all.onclick=()=>{ STATE.subcategoria=null; renderSubcategories(); renderProducts(); updateShareButtons(); };
  wrap.appendChild(all);

  subs.forEach(sc=>{
    const b=document.createElement("button");
    b.className="chip"+(STATE.subcategoria===sc?" active":"");
    b.textContent=sc;
    b.onclick=()=>{ STATE.subcategoria=sc; renderSubcategories(); renderProducts(); updateShareButtons(); };
    wrap.appendChild(b);
  });
  updateShareButtons();
}

function updateShareButtons(){
  $("btnViewAll").style.display = (STATE.categoria && STATE.categoria!=="VER TODO") ? "inline-flex":"none";
  $("btnShareCategory").style.display = (STATE.categoria && STATE.categoria!=="VER TODO") ? "inline-flex":"none";
  $("btnShareSub").style.display = (STATE.categoria && STATE.subcategoria) ? "inline-flex":"none";
}
$("btnViewAll").onclick=()=>{ STATE.categoria=null; STATE.subcategoria=null; $("searchInput").value=""; STATE.query=""; renderCategories(); renderSubcategories(); renderProducts(); };
$("btnShareCategory").onclick=()=>{ navigator.clipboard.writeText(location.origin+location.pathname+"#cat="+encodeURIComponent(STATE.categoria)); alert("Enlace copiado"); };
$("btnShareSub").onclick=()=>{ navigator.clipboard.writeText(location.origin+location.pathname+"#cat="+encodeURIComponent(STATE.categoria)+"&sub="+encodeURIComponent(STATE.subcategoria)); alert("Enlace copiado"); };

function filtered(){
  let list=DB.productos.slice();
  if(STATE.categoria){
    if(STATE.categoria==="OFERTAS") list=list.filter(isOffer);
    else if(STATE.categoria!=="VER TODO") list=list.filter(p=>p.categoria===STATE.categoria);
  }
  if(STATE.subcategoria) list=list.filter(p=>p.subcategoria===STATE.subcategoria);

  const q=(STATE.query||"").toLowerCase().trim();
  if(q) list=list.filter(p=>p.nombre.toLowerCase().includes(q) || p.descripcion.toLowerCase().includes(q));

  list.sort((a,b)=>{
    const av=a.stock>0?0:1, bv=b.stock>0?0:1;
    if(av!==bv) return av-bv;
    if(a.orden!==b.orden) return a.orden-b.orden;
    return a.nombre.localeCompare(b.nombre);
  });
  return list;
}

function renderProducts(){
  const grid=$("grid");
  const list=filtered();
  grid.innerHTML="";
  $("sectionTitle").textContent = `Productos (${list.length})`;

  list.forEach(p=>{
    const c=document.createElement("div");
    c.className="card"+(isOut(p)?" out":"");
    c.innerHTML=`
      ${isOffer(p)?`<div class="offerTag">OFERTA</div>`:""}
      <img class="cardImg" src="${p.imagen||""}" alt="">
      <div class="cardBody">
        <div class="cardName">${p.nombre}</div>
        <div class="cardDesc">${p.descripcion||p.subcategoria||""}</div>
        <div class="priceRow">
          <div class="price ${isOffer(p)?"offer":""}">${money(p.precio)}</div>
          <div class="old">${isOffer(p)?money(p.precio_anterior):""}</div>
        </div>
        <button class="btn btnPrimary btnFull" ${isOut(p)?"disabled":""}>${isOut(p)?"Agotado":"Ver detalles"}</button>
      </div>
    `;
    if(isOut(p)){
      const wm=document.createElement("div");
      wm.className="watermark";
      wm.textContent="AGOTADO";
      c.appendChild(wm);
    }
    c.onclick=()=>openProduct(p);
    grid.appendChild(c);
  });
}

function openProduct(p){
  CURRENT_PRODUCT=p;

  $("modalName").textContent=p.nombre;
  $("modalSub").textContent=`${p.categoria}${p.subcategoria?(" Â· "+p.subcategoria):""}`;
  $("modalPrice").textContent=money(p.precio);
  $("modalOld").textContent=isOffer(p)?money(p.precio_anterior):"";
  $("modalDesc").textContent=p.descripcion||"";

  const urls=[p.imagen,p.galeria_1,p.galeria_2,p.galeria_3,p.galeria_4,p.galeria_5,p.galeria_6,p.galeria_7,p.galeria_8].filter(Boolean);
  const gallery=[...new Set(urls)].slice(0,8);

  $("modalMainImg").src=gallery[0]||"";

  const thumbs=$("modalThumbs");
  thumbs.innerHTML="";
  if(gallery.length<=1){ thumbs.style.display="none"; }
  else{
    thumbs.style.display="flex";
    gallery.forEach((src,idx)=>{
      const im=document.createElement("img");
      im.className="thumb"+(idx===0?" active":"");
      im.src=src;
      im.onclick=(e)=>{
        e.stopPropagation();
        $("modalMainImg").src=src;
        [...thumbs.children].forEach(x=>x.classList.remove("active"));
        im.classList.add("active");
      };
      thumbs.appendChild(im);
    });
  }

  const vids=$("modalVideos");
  vids.innerHTML="";
  if(!p.video){ vids.style.display="none"; }
  else{
    vids.style.display="flex";
    const a=document.createElement("a");
    a.className="vbtn"; a.href=p.video; a.target="_blank"; a.rel="noopener";
    a.textContent="Ver video";
    vids.appendChild(a);
  }

  $("modalHint").textContent="";
  $("btnAddCart").disabled=isOut(p);

  openModal($("prodModal"));
}

$("btnKeepBuying").onclick=()=>closeModal($("prodModal"));
$("btnGoPay").onclick=()=>{ closeModal($("prodModal")); openCart(); };

$("btnAddCart").onclick=()=>{
  const p=CURRENT_PRODUCT;
  if(!p || isOut(p)) return;

  let it=CART.find(x=>x.id===p.id);
  if(!it) CART.push({id:p.id, qty:1});
  else it.qty++;

  saveCart();
  $("modalHint").textContent="âœ… Agregado. Seguir comprando o ir a pagar.";
};

function openCart(){
  renderCart();
  updateTotals();
  showStep(1);
  openModal($("cartModal"));
}
$("btnCart").onclick=openCart;

let step=1;
function showStep(n){
  step=n;
  $("step1").style.display=n===1?"block":"none";
  $("step2").style.display=n===2?"block":"none";
  $("step3").style.display=n===3?"block":"none";
  $("tab1").classList.toggle("active",n===1);
  $("tab2").classList.toggle("active",n===2);
  $("tab3").classList.toggle("active",n===3);
  $("cartBack").style.visibility=n===1?"hidden":"visible";
  $("cartNext").textContent=n===3?"Enviar":"Continuar";
}
function renderCart(){
  const list=$("cartList");
  list.innerHTML="";
  if(!CART.length){ $("cartEmpty").style.display="block"; return; }
  $("cartEmpty").style.display="none";

  CART.forEach(it=>{
    const p=DB.productos.find(x=>x.id===it.id);
    if(!p) return;
    const row=document.createElement("div");
    row.className="cartItem";
    row.innerHTML=`
      <img class="cartItemImg" src="${p.imagen||""}">
      <div>
        <div class="cartItemName">${p.nombre}</div>
        <div class="cartItemMeta">${money(p.precio)} Â· Cant: ${it.qty}</div>
        <div class="qtyRow">
          <div class="qtyCtrls">
            <button class="qtyBtn">âˆ’</button>
            <div class="qtyNum">${it.qty}</div>
            <button class="qtyBtn">+</button>
          </div>
          <button class="trashBtn">ðŸ—‘ Eliminar</button>
        </div>
      </div>
    `;
    const minus=row.querySelectorAll(".qtyBtn")[0];
    const plus=row.querySelectorAll(".qtyBtn")[1];
    const num=row.querySelector(".qtyNum");
    const del=row.querySelector(".trashBtn");
    minus.onclick=()=>{ it.qty=Math.max(1,it.qty-1); num.textContent=it.qty; saveCart(); updateTotals(); };
    plus.onclick=()=>{ it.qty++; num.textContent=it.qty; saveCart(); updateTotals(); };
    del.onclick=()=>{ CART=CART.filter(x=>x.id!==it.id); saveCart(); renderCart(); updateTotals(); };
    list.appendChild(row);
  });
}

function updateTotals(){
  const sub=cartSubtotal();
  $("cartSubtotal").textContent=money(sub);
  $("cartShip").textContent=money(0);
  $("cartTotal").textContent=money(sub);
}

$("cartBack").onclick=()=>{ if(step>1) showStep(step-1); };
$("cartNext").onclick=()=>{
  if(step===1){ if(!CART.length){alert("Carrito vacÃ­o"); return;} showStep(2); return; }
  if(step===2){ showStep(3); return; }
  if(step===3){
    const a=ajustesMap();
    const wa=(a.whatsapp_numero||WA_DEFAULT).replace(/\D/g,"");
    const msg=[];
    msg.push("ðŸ›’ Pedido SDC");
    CART.forEach(it=>{
      const p=DB.productos.find(x=>x.id===it.id);
      if(p) msg.push(`- ${it.qty} x ${p.nombre} (${money(p.precio)})`);
    });
    msg.push("Total: "+money(cartSubtotal()));
    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg.join("\n"))}`,"_blank");
  }
};

$("btnSendWA").onclick=()=>$("cartNext").click();

loadCart();
loadAPI();
</script>

</body>
</html>